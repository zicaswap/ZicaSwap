<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
   <title>ZicaSwap - Decentralized Exchange on Sidra Chain | Trade, Earn, Grow</title>
  <meta name="google-site-verification" content="jtn_hlAfPbAOul0xNc9EbHGeko6e5CwWGHV2GYQ0_dY" />
  <meta name="title" content="ZicaSwap - Sidra Chain Decentralized Exchange | Trade, Earn, Grow">
  <meta name="description" content="Experience lightning-fast swaps, yield farming, and seamless liquidity provision on Sidra Chain's premier decentralized exchange. Low fees, high security, and competitive APY.">
  <meta name="keywords" content="zicaswap, sidra chain, sidra swap, sidra dex, decentralized exchange, defi, swap, liquidity, yield farming, crypto, blockchain, DEX, zicaswap.xyz">
  <meta name="author" content="ZicaSwap">
  <meta name="robots" content="index, follow">

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://zicaswap.xyz/">
  <meta property="og:title" content="ZicaSwap - Decentralized Exchange on Sidra Chain">
  <meta property="og:description" content="Trade, Earn, and Grow on Sidra Chain. Experience lightning-fast swaps, yield farming, and seamless liquidity provision.">
  <meta property="og:image" content="https://zicaswap.xyz/assets/og-image.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:site_name" content="ZicaSwap">

  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://zicaswap.xyz/">
  <meta property="twitter:title" content="ZicaSwap - Decentralized Exchange on Sidra Chain">
  <meta property="twitter:description" content="Trade, Earn, and Grow on Sidra Chain. Experience lightning-fast swaps, yield farming, and seamless liquidity provision.">
  <meta property="twitter:image" content="https://zicaswap.xyz/assets/twitter-image.png">
  <meta name="twitter:site" content="@zicaswap_xyz">
  <meta name="twitter:creator" content="@zicaswap_xyz">

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="https://zicaswap.xyz/assets/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="https://zicaswap.xyz/assets/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="https://zicaswap.xyz/assets/favicon-96x96.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://zicaswap.xyz/assets/apple-touch-icon.png">

  <!-- Canonical URL -->
  <link rel="canonical" href="https://zicaswap.xyz/">

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "ZicaSwap",
    "url": "https://zicaswap.xyz/",
    "logo": "https://zicaswap.xyz/assets/zica.png",
    "description": "ZicaSwap is a decentralized exchange (DEX) built on Sidra Chain | Trade, Earn, Grow.",
    "foundingDate": "2025",
    "sameAs": [
      "https://twitter.com/ZicaSwap_xyz",
      "https://t.me/ZicaSwap_xyz",
      "https://github.com/zicaswap_xyz"
    ]
  }
  </script>

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "Zicaswap Sidra DEX",
  "url": "https://zicaswap.xyz/",
  "description": "DEX Decentralized Exchange on Sidra Network",
  "applicationCategory": "FinanceApplication",
  "operatingSystem": "All",
  "offers": {
    "@type": "Offer",
    "category": "FinancialService",
    "description": "Decentralized token swapping, liquidity provision, and yield farming"
  }
}
</script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary: #1a7f5e;
      --primary-dark: #146c4d;
      --accent: #31d0aa;
      --text: #ffffff;
      --muted: rgba(255,255,255,0.12);
      --card-bg: rgba(14,42,33,0.85);
      --card-border: rgba(26,127,94,0.12);
      --glass: rgba(255,255,255,0.03);
      --warning: #ff9800;
      --danger: #f44336;
      --success: #4caf50;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Kanit',sans-serif;
      background:linear-gradient(180deg,#04140d 0%, #07261b 100%);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      min-height:100vh;
    }
    .header{background: linear-gradient(135deg,var(--primary-dark),#0f593c);padding:12px 0;position:sticky;top:0;z-index:1300;border-bottom:1px solid rgba(0,0,0,0.25);}
    .nav-container{max-width:1200px;margin:0 auto;padding:0 20px;display:flex;align-items:center;justify-content:space-between;gap:12px;position:relative;}
    .logo{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--text)}
    .logo img{width:40px;height:40px;border-radius:8px;object-fit:cover}
    .logo span{font-weight:700;font-size:18px}
    .connect-wallet{background:var(--accent);color:#052017;border:none;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer;z-index:1400;position:relative}
    .menu-dot-btn{width:40px;height:40px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text);font-size:18px;position:relative;z-index:1400;}
    .menu-dropdown{position:absolute;right:20px;top:64px;min-width:180px;background:rgba(255,255,255,0.03);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,0.04);border-radius:12px;padding:8px;box-shadow:0 12px 30px rgba(0,0,0,0.5);opacity:0;transform:translateY(-6px);pointer-events:none;transition:all .18s ease;z-index:1600;}
    .menu-dropdown.show{opacity:1;transform:translateY(0);pointer-events:auto}
    .menu-item{padding:10px;border-radius:10px;color:var(--text);cursor:pointer;font-weight:600}
    .menu-item:hover{background:rgba(255,255,255,0.02)}
    .menu-sep{height:1px;background:rgba(255,255,255,0.03);margin:6px 0;border-radius:2px}
    .main{max-width:1200px;margin:32px auto;padding:0 20px}
    .swap-row{display:flex;gap:24px;align-items:flex-start}
    @media (max-width:980px){.swap-row{flex-direction:column;padding-bottom:40px}}
    .card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:16px;padding:18px;flex:1;max-width:540px;box-shadow:0 10px 30px rgba(0,0,0,0.55)}
    .card-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .title{font-size:20px;font-weight:700}
    .token-block{background:rgba(255,255,255,0.02);border-radius:12px;padding:10px;margin-bottom:12px;border:1px solid transparent}
    .token-block:focus-within{border-color:var(--primary)}
    .input-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .label{color:#cfece0;font-size:13px}
    .balance{color:var(--muted);font-size:13px;cursor:pointer}
    .row{display:flex;gap:12px;align-items:center}
    .select-wrap{position:relative;min-width:140px}
    .select{display:flex;align-items:center;gap:8px;padding:8px;border-radius:10px;background:rgba(0,0,0,0.12);cursor:pointer;border:1px solid rgba(255,255,255,0.02);min-width:120px;z-index:1500}
    .select img{width:34px;height:34px;border-radius:8px;object-fit:cover}
    .symbol{font-weight:700}
    .amount-wrap{flex:1;display:flex;flex-direction:column;align-items:flex-end;min-width:0}
    .amount{width:100%;background:transparent;border:none;color:var(--text);font-size:22px;font-weight:700;text-align:right;padding:6px 0;outline:none}
    .amount::placeholder{color:var(--muted)}
    .meta{display:flex;justify-content:space-between;align-items:center;gap:8px;width:100%;margin-top:8px}
    .usd{color:var(--muted);font-size:13px;white-space:nowrap}
    .max{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:6px 10px;border-radius:10px;font-weight:700;color:var(--primary);cursor:pointer;font-size:13px}
    .max:disabled{opacity:0.5;cursor:not-allowed}
    .token-list{position:absolute;top:calc(100% + 8px);left:0;background:rgba(255,255,255,0.03);backdrop-filter:blur(6px);border-radius:12px;padding:8px;border:1px solid rgba(255,255,255,0.04);min-width:320px;max-height:320px;overflow:auto;z-index:2200;box-shadow:0 12px 32px rgba(0,0,0,0.5);pointer-events:auto}
    .token-search input{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text);margin-bottom:8px}
    .token-option{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;cursor:pointer}
    .token-option:hover{background:rgba(255,255,255,0.02)}
    .token-addr{font-size:12px;color:var(--muted)}
    .controls{text-align:center;margin:8px 0}
    .flip{background:var(--primary-dark);border:none;color:white;width:44px;height:44px;border-radius:50%;cursor:pointer;font-size:18px}
    .price{background:rgba(255,255,255,0.02);padding:10px;border-radius:10px;margin-top:12px}
    .info{display:flex;justify-content:space-between;color:var(--muted);font-size:13px;padding:6px 0}
    .primary{width:100%;background:var(--primary);border:none;padding:12px;border-radius:12px;font-weight:800;font-size:16px;cursor:pointer;margin-top:12px}
    .primary:disabled{opacity:0.5;cursor:not-allowed}
    .secondary{width:100%;background:transparent;border:1px solid var(--primary);padding:12px;border-radius:12px;font-weight:800;font-size:16px;cursor:pointer;margin-top:12px;color:var(--primary)}
    .spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,0.12);border-top-color:var(--text);border-radius:50%;animation:spin 1s linear infinite;vertical-align:middle;margin-right:8px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .panel{flex:1;min-width:260px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:12px;padding:16px}
    .panel h4{font-weight:700;margin-bottom:10px}
    .panel-row{display:flex;justify-content:space-between;color:var(--muted);padding:8px 0}
    footer{margin-top:28px;text-align:center;padding:20px;color:var(--muted);font-size:13px}

    /* Settings Modal */
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:3000;display:flex;align-items:center;justify-content:center;padding:20px}
    .modal{background:var(--card-bg);border:1px solid var(--card-border);border-radius:16px;padding:20px;max-width:400px;width:100%}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .modal-title{font-size:18px;font-weight:700}
    .close-modal{background:transparent;border:none;color:var(--text);font-size:20px;cursor:pointer}
    .setting-item{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid rgba(255,255,255,0.05)}
    .setting-item:last-child{border-bottom:none}
    .setting-label{font-weight:600}
    .slippage-input{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:8px 12px;color:var(--text);width:80px;text-align:center}
    .slippage-input:focus{outline:none;border-color:var(--primary)}

    /* Custom token feature */
    .add-token-btn{display:flex;align-items:center;justify-content:center;gap:8px;padding:12px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px dashed rgba(255,255,255,0.1);cursor:pointer;margin-top:8px;transition:all 0.2s ease}
    .add-token-btn:hover{background:rgba(255,255,255,0.04);border-color:var(--primary)}
    .add-token-btn span{font-weight:600;font-size:14px}
    .add-token-form{background:rgba(255,255,255,0.02);border-radius:12px;padding:16px;margin-top:12px;border:1px solid rgba(255,255,255,0.05)}
    .form-group{margin-bottom:12px}
    .form-label{display:block;color:var(--muted);font-size:13px;margin-bottom:6px}
    .form-input{width:100%;padding:10px;border-radius:8px;background:rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.05);color:var(--text);font-size:14px}
    .form-input:focus{outline:none;border-color:var(--primary)}
    .form-actions{display:flex;gap:8px;margin-top:16px}
    .btn{flex:1;padding:10px;border-radius:8px;font-weight:600;cursor:pointer;border:none;font-size:14px}
    .btn-primary{background:var(--primary);color:white}
    .btn-secondary{background:rgba(255,255,255,0.05);color:var(--text)}
    .warning-box{background:rgba(255,152,0,0.1);border:1px solid rgba(255,152,0,0.3);border-radius:8px;padding:12px;margin-top:12px}
    .warning-header{display:flex;align-items:center;gap:8px;color:var(--warning);font-weight:600;margin-bottom:6px}
    .warning-text{color:var(--warning);font-size:13px;line-height:1.4}
    .token-verified{color:var(--accent);font-size:11px;margin-left:6px}
    .token-imported{color:var(--primary);font-size:11px;margin-left:6px}
    .token-warning{color:var(--warning);font-size:11px;margin-left:6px}

    /* Price Impact Colors */
    .price-impact-low{color:var(--success)}
    .price-impact-medium{color:var(--warning)}
    .price-impact-high{color:var(--danger)}

    @media (max-width:520px){
      .select img{width:28px;height:28px}.amount{font-size:20px}.menu-dropdown{right:12px;left:auto}.token-list{min-width:260px;left:0;right:0}
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="header">
    <div class="nav-container">
      <a class="logo" href="swap.html">
        <img src="https://zicaswap.xyz/assets/zica.png" alt="ZicaSwap">
        <span>ZicaSwap</span>
      </a>

      <div style="display:flex;align-items:center;gap:8px;position:relative;">
        <button id="menuBtn" class="menu-dot-btn" title="Menu">⋮</button>
        <div id="menuDropdown" class="menu-dropdown" aria-hidden="true">
          <div class="menu-item" data-href="swap.html">Swap</div>
          <div class="menu-item" data-href="liquidity.html">Liquidity</div>
          <div class="menu-item" data-href="tokencreator.html">Create Token</div>
          <div class="menu-item" data-href="staking.html">Stake</div>
          <div class="menu-sep"></div>
          <div class="menu-item" data-href="docs.html">Docs</div>
        </div>

        <button id="connectBtn" class="connect-wallet">Connect Wallet</button>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="main">
    <div class="swap-row">
      <!-- SWAP CARD -->
      <section class="card" aria-label="Swap tokens">
        <div class="card-head">
          <div class="title">Swap</div>
          <button id="settingsBtn" class="menu-dot-btn" title="Settings">⚙️</button>
        </div>

        <!-- FROM -->
        <div class="token-block" id="fromBlock">
          <div class="input-head">
            <div class="label">From</div>
            <div id="fromBalance" class="balance">—</div>
          </div>
          <div class="row">
            <div class="select-wrap">
              <div id="fromSelect" class="select" tabindex="0" aria-haspopup="listbox" aria-expanded="false">
                <img id="fromLogo" src="https://zicaswap.xyz/assets/sidra.png" alt="">
                <div style="min-width:0">
                  <div id="fromSymbol" class="symbol">SIDRA</div>
                </div>
                <div style="margin-left:auto;color:var(--muted)">▼</div>
              </div>

              <div id="fromList" class="token-list" style="display:none"></div>
            </div>

            <div class="amount-wrap">
              <input id="fromAmount" class="amount" placeholder="0.0" inputmode="decimal" autocomplete="off">
              <div class="meta">
                <div id="fromUsd" class="usd">—</div>
                <button id="btnMax" class="max" disabled>MAX</button>
              </div>
            </div>
          </div>
        </div>

        <!-- SWAP CONTROLS -->
        <div class="controls">
          <button id="flipBtn" class="flip">↓↑</button>
        </div>

        <!-- TO -->
        <div class="token-block" id="toBlock">
          <div class="input-head">
            <div class="label">To</div>
            <div id="toBalance" class="balance">—</div>
          </div>
          <div class="row">
            <div class="select-wrap">
              <div id="toSelect" class="select" tabindex="0" aria-haspopup="listbox" aria-expanded="false">
                <img id="toLogo" src="https://zicaswap.xyz/assets/usdt.png" alt="">
                <div style="min-width:0">
                  <div id="toSymbol" class="symbol">USDT</div>
                </div>
                <div style="margin-left:auto;color:var(--muted)">▼</div>
              </div>

              <div id="toList" class="token-list" style="display:none"></div>
            </div>

            <div class="amount-wrap">
              <input id="toAmount" class="amount" placeholder="0.0" inputmode="decimal" autocomplete="off" readonly>
              <div class="meta">
                <div id="toUsd" class="usd">—</div>
                <button class="max" style="visibility:hidden">MAX</button>
              </div>
            </div>
          </div>
        </div>

        <!-- PRICE INFO -->
        <div class="price">
          <div class="info">
            <div>Price</div>
            <div id="priceInfo">—</div>
          </div>
          <div class="info">
            <div>Minimum received</div>
            <div id="minReceived">—</div>
          </div>
          <div class="info">
            <div>Price Impact</div>
            <div id="priceImpact">—</div>
          </div>
        </div>

        <!-- SWAP BUTTON -->
        <button id="swapBtn" class="primary">Connect Wallet</button>

        <div style="margin-top:12px;color:var(--muted);font-size:13px;text-align:center">
          <div id="status">Ready</div>
          <div id="txLink" style="margin-top:6px;font-size:12px;word-break:break-all"></div>
        </div>
      </section>

      <!-- INFO PANEL -->
      <aside class="panel" aria-label="Swap information">
        <h4>Swap Information</h4>
        <div class="panel-row"><div>Network</div><div>Sidra Chain</div></div>
        <div class="panel-row"><div>Router</div><div style="font-size:12px">ZicaSwap Router</div></div>
        <div class="panel-row"><div>Slippage</div><div id="slippageDisplay">0.5%</div></div>

        <h4 style="margin-top:14px">Transaction Details</h4>
        <div class="panel-row"><div>Route</div><div id="routeInfo">—</div></div>
        <div class="panel-row"><div>Liquidity Provider Fee</div><div>0.25%</div></div>
        <div class="panel-row"><div>Pool Liquidity</div><div id="poolLiquidity">—</div></div>
      </aside>
    </div>
  </main>

  <!-- SETTINGS MODAL -->
  <div id="settingsModal" class="modal-overlay" style="display:none">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Settings</div>
        <button class="close-modal" onclick="closeSettingsModal()">×</button>
      </div>

      <div class="setting-item">
        <div class="setting-label">Slippage Tolerance</div>
        <input type="text" class="slippage-input" id="slippageInput" value="0.5" onchange="updateSlippage()">%
      </div>

      <div class="setting-item">
        <div class="setting-label">Transaction Deadline</div>
        <input type="text" class="slippage-input" id="deadlineInput" value="20" onchange="updateDeadline()">mins
      </div>

      <div class="setting-item">
        <div class="setting-label">Expert Mode</div>
        <input type="checkbox" id="expertMode" onchange="toggleExpertMode()">
      </div>
    </div>
  </div>

  <footer>© 2025 ZicaSwap. Built on Sidra Chain</footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.1/ethers.umd.min.js"></script>
  <script>
    // CONFIG - Sidra Chain
    const ROUTER = '0xECd5BFE9044640D19dFd2Cdd4F360551d8E3E34C';
    const FACTORY = '0x7Cba03E40FCE39c55AC3280E4eedB9c5d733D35D';
    const WSIDRA = '0x00EDdD9621Fb08436d0331c149D1690909a5906d'; // Wrapped Sidra (WETH equivalent)
    const ZICA = '0x82741ff5937933244eb562A4b396f8079F1de914'; // Zica token
    const USDT = '0xF1815bd50389c46847f0Bda824eC8da914045D14';
    const SIDURU = '0x6043921876841e8f421a4f9E748825DC6C430255'; // SIDURU (SDR token)
    const RPC = 'https://node.sidrachain.com';
    const EXPLORER = 'https://ledger.sidrachain.com';
    const CHAIN_ID_HEX = '0x5C8'; // Sesuaikan dengan chain ID Sidra Chain

    const ROUTER_ABI = [
      'function getAmountsOut(uint amountIn, address[] memory path) public view returns (uint[] memory amounts)',
      'function swapExactTokensForTokens(uint amountIn, uint amountOutMin, address[] calldata path, address to, uint deadline) external returns (uint[] memory amounts)',
      'function swapExactETHForTokens(uint amountOutMin, address[] calldata path, address to, uint deadline) external payable returns (uint[] memory amounts)',
      'function swapExactTokensForETH(uint amountIn, uint amountOutMin, address[] calldata path, address to, uint deadline) external returns (uint[] memory amounts)'
    ];

    const FACTORY_ABI = [
      'function getPair(address tokenA, address tokenB) external view returns (address pair)'
    ];

    const PAIR_ABI = [
      'function getReserves() external view returns (uint112 reserve0, uint112 reserve1, uint32 blockTimestampLast)',
      'function token0() external view returns (address)',
      'function token1() external view returns (address)',
      'function totalSupply() external view returns (uint256)'
    ];

    const ERC20_ABI = [
      'function balanceOf(address account) external view returns (uint256)',
      'function transfer(address to, uint256 amount) external returns (bool)',
      'function approve(address spender, uint256 amount) external returns (bool)',
      'function allowance(address owner, address spender) external view returns (uint256)',
      'function decimals() external view returns (uint8)',
      'function symbol() external view returns (string memory)',
      'function name() external view returns (string memory)'
    ];

    const WSIDRA_ABI = [
      'function deposit() payable',
      'function withdraw(uint wad)',
      ...ERC20_ABI
    ];

    // STATE
    let provider = null;
    let signer = null;
    let account = null;
    let router = null;
    let factory = null;
    let wSidraContract = null;
    let slippage = 0.5;
    let deadline = 20;
    let needsApproval = false;
    let currentPairContract = null;
    let currentReserves = { reserveA: 0, reserveB: 0 };

    const DEFAULT_TOKENS = [
      { symbol: 'SIDRA', address: 'SIDRA_NATIVE', logo: 'https://zicaswap.xyz/assets/sidra.png', decimals: 18, verified: true},
      { symbol: 'WSIDRA', address: WSIDRA, logo: 'https://zicaswap.xyz/assets/wsidra.png', decimals: 18, verified: true},
      { symbol: 'USDT', address: USDT, logo: 'https://zicaswap.xyz/assets/usdt.png', decimals: 6, verified: true},
      { symbol: 'ZICA', address: ZICA, logo: 'https://zicaswap.xyz/assets/zica.png', decimals: 18, verified: true},
      { symbol: 'SIDURU', address: SIDURU, logo: 'https://zicaswap.xyz/assets/siduru.png', decimals: 18, verified: true}
    ];

    let tokens = DEFAULT_TOKENS.slice();
    let selectedFrom = tokens[0]; // SIDRA native
    let selectedTo = tokens[2]; // USDT

    const $ = id => document.getElementById(id);

    function showToast(msg, t = 2400){
      const el = document.createElement('div'); el.className = 'toast'; el.textContent = msg;
      el.style.position = 'fixed'; el.style.bottom = '20px'; el.style.left = '50%'; el.style.transform = 'translateX(-50%)';
      el.style.background = 'var(--primary)'; el.style.color = 'white'; el.style.padding = '12px 20px';
      el.style.borderRadius = '8px'; el.style.zIndex = '9999'; el.style.fontWeight = '600';
      el.style.opacity = '0'; el.style.transition = 'opacity .18s';
      document.body.appendChild(el);
      setTimeout(()=> el.style.opacity = '1', 10);
      setTimeout(()=> { el.style.opacity = '0'; setTimeout(()=> el.remove(), 300); }, t);
    }

    function setStatus(s){ $('status').textContent = s }

    // FUNGSI BARU: Hitung price impact yang akurat berdasarkan Constant Product Formula
    function calculateAccuratePriceImpact(amountIn, reserveIn, reserveOut, fromDecimals, toDecimals) {
        if (!reserveIn || !reserveOut || reserveIn.eq(0) || reserveOut.eq(0)) {
            return 100; // Pool kosong atau tidak ada liquidity
        }

        // Convert reserves to proper decimals
        const reserveInFormatted = parseFloat(ethers.utils.formatUnits(reserveIn, fromDecimals));
        const reserveOutFormatted = parseFloat(ethers.utils.formatUnits(reserveOut, toDecimals));
        const amountInFormatted = parseFloat(ethers.utils.formatUnits(amountIn, fromDecimals));

        // Harga sebelum trade (spot price)
        const priceBefore = reserveOutFormatted / reserveInFormatted;

        // Constant Product Formula dengan fee 0.3%
        const amountInWithFee = amountIn.mul(997); // 0.3% fee
        const numerator = amountInWithFee.mul(reserveOut);
        const denominator = reserveIn.mul(1000).add(amountInWithFee);
        const amountOut = numerator.div(denominator);

        // Reserves setelah trade
        const newReserveIn = reserveIn.add(amountIn);
        const newReserveOut = reserveOut.sub(amountOut);

        // Harga setelah trade (new spot price)
        const newReserveInFormatted = parseFloat(ethers.utils.formatUnits(newReserveIn, fromDecimals));
        const newReserveOutFormatted = parseFloat(ethers.utils.formatUnits(newReserveOut, toDecimals));
        const priceAfter = newReserveOutFormatted / newReserveInFormatted;

        // Price Impact = (Price Before - Price After) / Price Before * 100%
        const priceImpact = ((priceBefore - priceAfter) / priceBefore) * 100;

        console.log('Price Impact Calculation:', {
            reserveIn: reserveInFormatted,
            reserveOut: reserveOutFormatted,
            amountIn: amountInFormatted,
            priceBefore,
            priceAfter,
            priceImpact
        });

        return Math.max(0, priceImpact); // Tidak boleh negatif
    }

    // FUNGSI BARU: Dapatkan data pool dari blockchain
    async function getPoolReserves(tokenA, tokenB) {
        if (!provider) return null;

        try {
            // Untuk native token (SIDRA), gunakan WSIDRA sebagai representasi
            const addressA = tokenA.address === 'SIDRA_NATIVE' ? WSIDRA : tokenA.address;
            const addressB = tokenB.address === 'SIDRA_NATIVE' ? WSIDRA : tokenB.address;

            // Dapatkan alamat pair dari factory
            const pairAddress = await factory.getPair(addressA, addressB);

            if (pairAddress === '0x0000000000000000000000000000000000000000') {
                $('poolLiquidity').textContent = 'No liquidity';
                return null; // Pair tidak ada
            }

            // Dapatkan reserves dari pair contract
            const pairContract = new ethers.Contract(pairAddress, PAIR_ABI, provider);
            const [token0, reserves] = await Promise.all([
                pairContract.token0(),
                pairContract.getReserves()
            ]);

            const [reserve0, reserve1] = reserves;

            // Tentukan reserve untuk token A dan B berdasarkan urutan di pool
            let reserveA, reserveB;
            if (token0.toLowerCase() === addressA.toLowerCase()) {
                reserveA = reserve0;
                reserveB = reserve1;
            } else {
                reserveA = reserve1;
                reserveB = reserve0;
            }

            // Simpan current pair contract untuk update real-time
            currentPairContract = pairContract;
            currentReserves = { reserveA, reserveB };

            // Update display liquidity dengan format yang benar
            const tokenADecimals = token0.toLowerCase() === addressA.toLowerCase() ? tokenA.decimals : tokenB.decimals;
            const tokenBDecimals = token0.toLowerCase() === addressA.toLowerCase() ? tokenB.decimals : tokenA.decimals;

            const liquidityA = ethers.utils.formatUnits(reserveA, tokenADecimals);
            const liquidityB = ethers.utils.formatUnits(reserveB, tokenBDecimals);

            $('poolLiquidity').textContent = `${parseFloat(liquidityA).toLocaleString()} ${tokenA.symbol} / ${parseFloat(liquidityB).toLocaleString()} ${tokenB.symbol}`;

            console.log('Pool Reserves:', {
                tokenA: tokenA.symbol,
                tokenB: tokenB.symbol,
                reserveA: parseFloat(liquidityA),
                reserveB: parseFloat(liquidityB),
                pairAddress
            });

            return { reserveA, reserveB, pairAddress };

        } catch (error) {
            console.error('Error getting pool reserves:', error);
            $('poolLiquidity').textContent = 'Error loading';
            return null;
        }
    }

    // MENU
    const menuBtn = $('menuBtn');
    const menuDropdown = $('menuDropdown');
    menuBtn.addEventListener('click', (e)=>{ e.stopPropagation(); menuDropdown.classList.toggle('show'); });
    menuDropdown.querySelectorAll('.menu-item').forEach(it=>{ 
        it.addEventListener('click', ()=> { 
            const href = it.getAttribute('data-href');
            if (href) {
                window.location.href = href;
            }
        }); 
    });
    document.addEventListener('click', ()=> menuDropdown.classList.remove('show'));

    // SETTINGS MODAL
    $('settingsBtn').addEventListener('click', ()=> $('settingsModal').style.display = 'flex');
    function closeSettingsModal(){ $('settingsModal').style.display = 'none'; }
    function updateSlippage(){ 
        slippage = parseFloat($('slippageInput').value) || 0.5; 
        $('slippageDisplay').textContent = slippage + '%';
        updatePriceInfo();
    }
    function updateDeadline(){ deadline = parseInt($('deadlineInput').value) || 20; }
    function toggleExpertMode(){ 
        if($('expertMode').checked) {
            showToast('Expert mode enabled - use with caution!', 3000);
        }
    }

    // DROPDOWNS
    function buildTokenListHtml(type){
        const listEl = (type==='from') ? $('fromList') : $('toList');
        listEl.innerHTML = '';
        const search = document.createElement('div'); search.className = 'token-search';
        search.innerHTML = `<input placeholder="Search token..." oninput="filterTokens('${type}', this.value)" />`;
        listEl.appendChild(search);
        const header = document.createElement('div'); header.style.color = 'var(--muted)'; header.style.fontSize='13px'; header.style.marginBottom = '8px'; header.textContent = `Select Token (${tokens.length})`;
        listEl.appendChild(header);
        for(const t of tokens){
            const opt = document.createElement('div'); opt.className = 'token-option'; opt.setAttribute('data-addr', t.address);
            let statusBadge = '';
            if (t.verified) {
                statusBadge = '<span class="token-verified">✓ Verified</span>';
            } else if (t.custom) {
                statusBadge = '<span class="token-imported">Imported</span>';
            } else if (t.warning) {
                statusBadge = '<span class="token-warning">⚠️ Unknown</span>';
            }

            opt.innerHTML = `<img src="${t.logo}" style="width:28px;height:28px;border-radius:6px;margin-right:8px"/>
                            <div style="flex:1;min-width:0">
                                <div style="font-weight:700">${t.symbol} ${statusBadge}</div>
                                <div class="token-addr">${t.address === 'SIDRA_NATIVE' ? 'Native Token' : (t.address.substring(0,6)+'...'+t.address.substring(38))}</div>
                            </div>
                            <div id="bal-${t.symbol}" style="color:var(--muted);font-size:13px">—</div>`;
            opt.addEventListener('click', (e)=>{ e.stopPropagation(); selectToken(type, t); });
            listEl.appendChild(opt);
        }

        // Add "Add Custom Token" button at the bottom
        const addTokenBtn = document.createElement('div');
        addTokenBtn.className = 'add-token-btn';
        addTokenBtn.innerHTML = '<span>+ Add Custom Token</span>';
        addTokenBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            showAddTokenForm(type);
        });
        listEl.appendChild(addTokenBtn);

        if(tokens.length===0){ const no = document.createElement('div'); no.className='token-addr'; no.style.padding='12px'; no.textContent='No tokens'; listEl.appendChild(no); }
        listEl.style.display = 'block'; listEl.style.pointerEvents = 'auto';
    }

    // Function to show add token form
    function showAddTokenForm(type) {
        const listEl = (type==='from') ? $('fromList') : $('toList');

        // Check if form already exists
        if (listEl.querySelector('.add-token-form')) {
            return;
        }

        const form = document.createElement('div');
        form.className = 'add-token-form';
        form.innerHTML = `
            <div class="form-group">
                <label class="form-label">Token Contract Address</label>
                <input type="text" class="form-input" id="tokenAddressInput" placeholder="0x..." />
            </div>
            <div class="warning-box">
                <div class="warning-header">
                    <span>⚠️</span>
                    <span>Security Warning</span>
                </div>
                <div class="warning-text">
                    Anyone can create ERC-20 tokens. Verify the token contract address before adding it. 
                    Fake tokens may look similar to legitimate ones. Always double-check the contract address from official sources.
                </div>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" id="cancelAddToken">Cancel</button>
                <button class="btn btn-primary" id="importToken">Import Token</button>
            </div>
        `;

        listEl.appendChild(form);

        // Focus on input
        setTimeout(() => {
            const input = form.querySelector('#tokenAddressInput');
            if (input) input.focus();
        }, 100);

        // Add event listeners
        form.querySelector('#cancelAddToken').addEventListener('click', (e) => {
            e.stopPropagation();
            form.remove();
        });

        form.querySelector('#importToken').addEventListener('click', (e) => {
            e.stopPropagation();
            importCustomToken(type, form.querySelector('#tokenAddressInput').value);
        });

        // Allow Enter key to import
        form.querySelector('#tokenAddressInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.stopPropagation();
                importCustomToken(type, form.querySelector('#tokenAddressInput').value);
            }
        });
    }

    // Function to import custom token
    async function importCustomToken(type, address) {
        if (!address || address.trim() === '') {
            showToast('Please enter a token address');
            return;
        }

        // Basic validation
        if (!/^0x[a-fA-F0-9]{40}$/.test(address.trim())) {
            showToast('Invalid token address format');
            return;
        }

        // Check if token already exists
        const existingToken = tokens.find(t => 
            t.address.toLowerCase() === address.trim().toLowerCase()
        );

        if (existingToken) {
            showToast('Token already in list');
            selectToken(type, existingToken);
            return;
        }

        try {
            setStatus('Importing token...');

            if (!provider) {
                provider = new ethers.providers.JsonRpcProvider(RPC);
            }

            const tokenContract = new ethers.Contract(address, ERC20_ABI, provider);

            // Get token details
            const [symbol, decimals] = await Promise.all([
                tokenContract.symbol(),
                tokenContract.decimals()
            ]);

            // Create token object
            const newToken = {
                symbol: symbol,
                address: address,
                decimals: decimals,
                logo: 'https://zicaswap.xyz/assets/unknown.png',
                custom: true,
                verified: false
            };

            // Add to tokens list
            tokens.push(newToken);

            // Save to localStorage
            saveCustomTokens();

            // Select the token
            selectToken(type, newToken);

            // Rebuild token list to show new token
            buildTokenListHtml(type);

            showToast(`Token ${symbol} imported successfully`);
            setStatus('Token imported');

        } catch (error) {
            console.error('Error importing token:', error);
            showToast('Failed to import token. Check the address and try again.');
            setStatus('Import failed');
        }
    }

    // Save custom tokens to localStorage
    function saveCustomTokens() {
        const customTokens = tokens.filter(t => t.custom);
        localStorage.setItem('zicaswap_custom_tokens', JSON.stringify(customTokens));
    }

    // Load custom tokens from localStorage
    function loadCustomTokens() {
        try {
            const stored = localStorage.getItem('zicaswap_custom_tokens');
            if (stored) {
                const customTokens = JSON.parse(stored);
                customTokens.forEach(ct => {
                    if (!tokens.some(t => t.address.toLowerCase() === ct.address.toLowerCase())) {
                        tokens.push(ct);
                    }
                });
            }
        } catch (error) {
            console.error('Error loading custom tokens:', error);
        }
    }

    window.filterTokens = function(type, term){ const listEl = (type==='from') ? $('fromList') : $('toList'); const opts = listEl.querySelectorAll('.token-option'); opts.forEach(o=>{ const text = o.textContent.toLowerCase(); const ok = text.includes((term||'').toLowerCase()); o.style.display = ok ? 'flex' : 'none'; }); };

    $('fromSelect').addEventListener('click', (e)=>{ e.stopPropagation(); const el = $('fromList'); if(el.style.display === 'block'){ el.style.display = 'none'; } else { buildTokenListHtml('from'); el.style.display = 'block'; $('toList').style.display = 'none'; } });
    $('toSelect').addEventListener('click', (e)=>{ e.stopPropagation(); const el = $('toList'); if(el.style.display === 'block'){ el.style.display = 'none'; } else { buildTokenListHtml('to'); el.style.display = 'block'; $('fromList').style.display = 'none'; } });
    document.addEventListener('click', (e)=>{ if(!e.target.closest('.select-wrap')){ $('fromList').style.display = 'none'; $('toList').style.display = 'none'; } });

    async function selectToken(type, token){
        if(type==='from'){ selectedFrom = token; $('fromLogo').src = token.logo; $('fromSymbol').textContent = token.symbol; $('fromList').style.display = 'none'; }
        else{ selectedTo = token; $('toLogo').src = token.logo; $('toSymbol').textContent = token.symbol; $('toList').style.display = 'none'; }

        // Dapatkan data pool ketika token berubah
        await getPoolReserves(selectedFrom, selectedTo);

        updateBalances(); 
        updatePriceInfo();
        updateSwapBtn(); 
    }

    // FLIP TOKENS
    $('flipBtn').addEventListener('click', async ()=>{
        const temp = selectedFrom;
        selectedFrom = selectedTo;
        selectedTo = temp;

        $('fromLogo').src = selectedFrom.logo;
        $('fromSymbol').textContent = selectedFrom.symbol;
        $('toLogo').src = selectedTo.logo;
        $('toSymbol').textContent = selectedTo.symbol;

        // Also flip amounts
        const fromAmt = $('fromAmount').value;
        const toAmt = $('toAmount').value;
        $('fromAmount').value = toAmt;
        $('toAmount').value = fromAmt;

        // Dapatkan data pool baru
        await getPoolReserves(selectedFrom, selectedTo);

        updateBalances();
        updatePriceInfo();
        updateSwapBtn();
    });

    // WRAP/UNWRAP FUNCTIONS
    async function wrapSIDRA() {
        if (!account) {
            await connectWallet();
            return;
        }

        const fromAmt = $('fromAmount').value;
        if (!fromAmt || parseFloat(fromAmt) <= 0) {
            showToast('Enter SIDRA amount to wrap');
            return;
        }

        try {
            setStatus('Wrapping SIDRA...');
            const amountIn = ethers.utils.parseEther(fromAmt);

            const tx = await wSidraContract.deposit({
                value: amountIn,
                gasLimit: 300000
            });

            $('txLink').innerHTML = `<a href="${EXPLORER}/tx/${tx.hash}" target="_blank" style="color:var(--accent)">View on Explorer</a>`;
            setStatus('Wrapping SIDRA...');
            await tx.wait();

            showToast('SIDRA wrapped successfully!');
            setStatus('Wrap completed');
            await updateBalances();
            await updateDropdownBalances();

        } catch (error) {
            console.error('Wrap error:', error);
            showToast('Wrap failed: ' + (error.message || error));
            setStatus('Wrap failed');
        }
    }

    async function unwrapSIDRA() {
        if (!account) {
            await connectWallet();
            return;
        }

        const fromAmt = $('fromAmount').value;
        if (!fromAmt || parseFloat(fromAmt) <= 0) {
            showToast('Enter WSIDRA amount to unwrap');
            return;
        }

        try {
            setStatus('Unwrapping WSIDRA...');
            const amountIn = ethers.utils.parseEther(fromAmt);

            // Check allowance first
            const allowance = await wSidraContract.allowance(account, WSIDRA);
            if (allowance.lt(amountIn)) {
                setStatus('Approving WSIDRA...');
                const approveTx = await wSidraContract.approve(WSIDRA, ethers.constants.MaxUint256);
                await approveTx.wait();
            }

            setStatus('Unwrapping WSIDRA...');
            const tx = await wSidraContract.withdraw(amountIn, { gasLimit: 300000 });

            $('txLink').innerHTML = `<a href="${EXPLORER}/tx/${tx.hash}" target="_blank" style="color:var(--accent)">View on Explorer</a>`;
            setStatus('Unwrapping WSIDRA...');
            await tx.wait();

            showToast('WSIDRA unwrapped successfully!');
            setStatus('Unwrap completed');
            await updateBalances();
            await updateDropdownBalances();

        } catch (error) {
            console.error('Unwrap error:', error);
            showToast('Unwrap failed: ' + (error.message || error));
            setStatus('Unwrap failed');
        }
    }

    // WALLET & CHAIN HANDLING
    const connectBtn = $('connectBtn');
    connectBtn.addEventListener('click', connectWallet);
    async function ensureSidraChain(){
        if(!window.ethereum) return false;
        try{
            const net = await window.ethereum.request({ method: 'eth_chainId' });
            if(net !== CHAIN_ID_HEX){
                try{
                    await window.ethereum.request({ method: 'wallet_switchEthereumChain', params:[{ chainId: CHAIN_ID_HEX }] });
                    return true;
                }catch(switchErr){
                    if(switchErr.code === 4902){
                        await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [{ chainId: CHAIN_ID_HEX, chainName: 'Sidra Chain', rpcUrls:[RPC], nativeCurrency:{name:'SIDRA',symbol:'SIDRA',decimals:18}, blockExplorerUrls:[EXPLORER] }] });
                        return true;
                    }
                    return false;
                }
            }
            return true;
        }catch(e){
            console.error('ensureSidraChain', e);
            return false;
        }
    }

    async function connectWallet(){
        if(!window.ethereum){ alert('Please install MetaMask'); return; }
        try{
            await ensureSidraChain();
            const accounts = await window.ethereum.request({ method:'eth_requestAccounts' });
            account = accounts[0];
            provider = new ethers.providers.Web3Provider(window.ethereum);
            signer = provider.getSigner();
            router = new ethers.Contract(ROUTER, ROUTER_ABI, signer);
            factory = new ethers.Contract(FACTORY, FACTORY_ABI, provider);
            wSidraContract = new ethers.Contract(WSIDRA, WSIDRA_ABI, signer);
            connectBtn.textContent = account.substring(0,6) + '...' + account.substring(38);
            setStatus('Connected');

            // Dapatkan data pool setelah connect
            await getPoolReserves(selectedFrom, selectedTo);

            await updateBalances(); 
            await updateDropdownBalances(); 
            updateSwapBtn(); 
            updatePriceInfo();
        }catch(e){
            console.error('connectWallet', e);
            showToast('Connection failed: ' + (e.message || e));
        }
    }

    // listen for chain change and auto-handle
    if(window.ethereum){
        window.ethereum.on('chainChanged', async (chainId) => {
            console.log('chainChanged', chainId);
            if(chainId !== CHAIN_ID_HEX){
                setStatus('Wrong chain — switching...');
                try{ await ensureSidraChain(); setStatus('Switched to Sidra'); location.reload(); } catch(e){ setStatus('Please switch to Sidra chain in wallet'); }
            } else { setStatus('Connected to Sidra'); location.reload(); }
        });
        window.ethereum.on('accountsChanged', async (accs)=>{ 
            if(accs && accs.length>0){ 
                account = accs[0]; 
                connectBtn.textContent = account.substring(0,6) + '...' + account.substring(38); 
                await getPoolReserves(selectedFrom, selectedTo);
                updateBalances(); 
                updateDropdownBalances(); 
                updatePriceInfo(); 
            } else { 
                account = null; 
                connectBtn.textContent = 'Connect Wallet'; 
            } 
        });
    }

    // BALANCES & MAX
    async function updateBalances(){
        if(!provider || !account) return;
        try{
            if(selectedFrom.address === 'SIDRA_NATIVE'){
                const b = await provider.getBalance(account);
                $('fromBalance').textContent = parseFloat(ethers.utils.formatEther(b)).toFixed(4);
                $('btnMax').disabled = false;
            }else{
                const c = new ethers.Contract(selectedFrom.address, ERC20_ABI, provider);
                const b = await c.balanceOf(account);
                const d = await c.decimals();
                $('fromBalance').textContent = parseFloat(ethers.utils.formatUnits(b,d)).toFixed(4);
                $('btnMax').disabled = false;
            }
            if(selectedTo.address === 'SIDRA_NATIVE'){
                const b2 = await provider.getBalance(account);
                $('toBalance').textContent = parseFloat(ethers.utils.formatEther(b2)).toFixed(4);
            }else{
                const c2 = new ethers.Contract(selectedTo.address, ERC20_ABI, provider);
                const b2 = await c2.balanceOf(account);
                const d2 = await c2.decimals();
                $('toBalance').textContent = parseFloat(ethers.utils.formatUnits(b2,d2)).toFixed(4);
            }
        }catch(e){ console.error('updateBalances', e); }
    }

    async function updateDropdownBalances(){ 
        if(!provider || !account) return; 
        for(const t of tokens){ 
            try{ 
                let bal='0'; 
                if(t.address === 'SIDRA_NATIVE'){ 
                    const b = await provider.getBalance(account); 
                    bal = parseFloat(ethers.utils.formatEther(b)).toFixed(4); 
                } else { 
                    const c = new ethers.Contract(t.address, ERC20_ABI, provider); 
                    const b = await c.balanceOf(account); 
                    const d = await c.decimals(); 
                    bal = parseFloat(ethers.utils.formatUnits(b,d)).toFixed(4); 
                } 
                const el = document.querySelector(`#bal-${t.symbol}`); 
                if(el) el.textContent = bal; 
            }catch(e){ 
                const el = document.querySelector(`#bal-${t.symbol}`); 
                if(el) el.textContent = '0'; 
            } 
        } 
    }

    async function setMax(){ 
        if(!account || !provider){ await connectWallet(); return; } 
        try{ 
            if(selectedFrom.address === 'SIDRA_NATIVE'){ 
                const b = await provider.getBalance(account); 
                const usable = b.mul(95).div(100); 
                $('fromAmount').value = ethers.utils.formatEther(usable); 
            } else { 
                const c = new ethers.Contract(selectedFrom.address, ERC20_ABI, provider); 
                const b = await c.balanceOf(account); 
                const d = selectedFrom.decimals || await c.decimals(); 
                $('fromAmount').value = parseFloat(ethers.utils.formatUnits(b,d)).toFixed(d > 6 ? 6 : d); 
            } 
            updatePriceInfo();
        }catch(e){ console.error('setMax', e); showToast('Failed to read balance'); } 
    }
    $('btnMax').addEventListener('click', setMax);
    $('fromBalance').addEventListener('click', setMax);

    // CHECK APPROVAL
    async function checkApproval() {
        if (!account || !provider || selectedFrom.address === 'SIDRA_NATIVE') {
            needsApproval = false;
            return;
        }

        try {
            const fromAmt = $('fromAmount').value;
            if (!fromAmt || parseFloat(fromAmt) <= 0) {
                needsApproval = false;
                return;
            }

            const amountIn = ethers.utils.parseUnits(fromAmt, selectedFrom.decimals);
            const tokenContract = new ethers.Contract(selectedFrom.address, ERC20_ABI, provider);
            const allowance = await tokenContract.allowance(account, ROUTER);

            needsApproval = allowance.lt(amountIn);
        } catch (error) {
            console.error('Check approval error:', error);
            needsApproval = false;
        }
    }

    // PRICE CALCULATION DENGAN PRICE IMPACT AKURAT
    async function updatePriceInfo() {
        const fromAmt = $('fromAmount').value;
        if (!fromAmt || parseFloat(fromAmt) <= 0 || !provider) {
            $('toAmount').value = '';
            $('priceInfo').textContent = '—';
            $('minReceived').textContent = '—';
            $('priceImpact').textContent = '—';
            $('routeInfo').textContent = '—';
            return;
        }

        try {
            const amountIn = ethers.utils.parseUnits(fromAmt, selectedFrom.decimals);

            // Build path
            let path = [];
            if (selectedFrom.address === 'SIDRA_NATIVE') {
                path = [WSIDRA, selectedTo.address === 'SIDRA_NATIVE' ? WSIDRA : selectedTo.address];
            } else if (selectedTo.address === 'SIDRA_NATIVE') {
                path = [selectedFrom.address, WSIDRA];
            } else {
                path = [selectedFrom.address, selectedTo.address];
            }

            // Get quote dari router
            const amounts = await router.getAmountsOut(amountIn, path);
            const amountOut = amounts[amounts.length - 1];

            const fromAmtFormatted = parseFloat(fromAmt);
            const toAmtFormatted = parseFloat(ethers.utils.formatUnits(amountOut, selectedTo.decimals));

            // Update output amount
            $('toAmount').value = toAmtFormatted.toFixed(6);

            // Calculate price
            const price = toAmtFormatted / fromAmtFormatted;
            $('priceInfo').textContent = `1 ${selectedFrom.symbol} = ${price.toFixed(6)} ${selectedTo.symbol}`;

            // Calculate minimum received with slippage
            const minAmountOut = amountOut.mul(10000 - slippage * 100).div(10000);
            $('minReceived').textContent = parseFloat(ethers.utils.formatUnits(minAmountOut, selectedTo.decimals)).toFixed(6);

            // HITUNG PRICE IMPACT YANG AKURAT
            const priceImpactElement = $('priceImpact');
            let priceImpact = 0;

            if (currentReserves.reserveA && currentReserves.reserveB) {
                // Tentukan reserve in dan out berdasarkan token yang dipilih
                let reserveIn, reserveOut;

                // Untuk kasus SIDRA -> USDT: reserveIn = SIDRA, reserveOut = USDT
                if (selectedFrom.address === 'SIDRA_NATIVE') {
                    // Jika from adalah SIDRA native, gunakan WSIDRA sebagai reserveIn
                    reserveIn = currentReserves.reserveA; // Asumsi reserveA adalah WSIDRA
                    reserveOut = currentReserves.reserveB; // Asumsi reserveB adalah USDT
                } else if (selectedTo.address === 'SIDRA_NATIVE') {
                    // Jika to adalah SIDRA native, reserveIn adalah token, reserveOut adalah WSIDRA
                    reserveIn = currentReserves.reserveA;
                    reserveOut = currentReserves.reserveB;
                } else {
                    // Untuk token -> token, gunakan reserves sesuai urutan
                    reserveIn = currentReserves.reserveA;
                    reserveOut = currentReserves.reserveB;
                }

                // Pastikan reserves valid
                if (reserveIn && reserveOut && !reserveIn.eq(0) && !reserveOut.eq(0)) {
                    priceImpact = calculateAccuratePriceImpact(
                        amountIn, 
                        reserveIn, 
                        reserveOut,
                        selectedFrom.decimals,
                        selectedTo.decimals
                    );
                } else {
                    priceImpact = 0.1; // Fallback
                }
            } else {
                // Fallback jika tidak ada data pool
                priceImpact = 0.1;
            }

            priceImpactElement.textContent = priceImpact.toFixed(2) + '%';

            // Apply color based on price impact
            priceImpactElement.className = '';
            if (priceImpact < 1) {
                priceImpactElement.classList.add('price-impact-low');
            } else if (priceImpact < 5) {
                priceImpactElement.classList.add('price-impact-medium');
            } else {
                priceImpactElement.classList.add('price-impact-high');
            }

            // Route info
            $('routeInfo').textContent = `${selectedFrom.symbol} → ${selectedTo.symbol}`;

            // Check approval
            await checkApproval();
            updateSwapBtn();

        } catch (error) {
            console.error('Price calculation error:', error);
            $('toAmount').value = '';
            $('priceInfo').textContent = '—';
            $('minReceived').textContent = '—';
            $('priceImpact').textContent = '—';
            $('routeInfo').textContent = 'Insufficient liquidity';
            needsApproval = false;
            updateSwapBtn();
        }
    }

    // UPDATE SWAP BUTTON WITH APPROVAL LOGIC
    async function updateSwapBtn() {
        const btn = $('swapBtn');
        if (!account) {
            btn.textContent = 'Connect Wallet';
            btn.disabled = false;
            return;
        }

        const fromAmt = parseFloat($('fromAmount').value);
        if (!fromAmt || fromAmt <= 0) {
            btn.textContent = 'Enter Amount';
            btn.disabled = true;
            return;
        }

        // Check if this is a wrap/unwrap operation
        const isWrap = selectedFrom.symbol === 'SIDRA' && selectedTo.symbol === 'WSIDRA';
        const isUnwrap = selectedFrom.symbol === 'WSIDRA' && selectedTo.symbol === 'SIDRA';

        if (isWrap) {
            btn.textContent = 'Wrap';
            btn.disabled = false;
        } else if (isUnwrap) {
            btn.textContent = 'Unwrap';
            btn.disabled = false;
        } else if (needsApproval && selectedFrom.address !== 'SIDRA_NATIVE') {
            btn.textContent = 'Approve ' + selectedFrom.symbol;
            btn.disabled = false;
        } else {
            btn.textContent = 'Swap';
            btn.disabled = false;
        }
    }

    // SWAP FUNCTION
    async function executeSwap() {
        if (!account) {
            await connectWallet();
            return;
        }

        const fromAmt = $('fromAmount').value;
        if (!fromAmt || parseFloat(fromAmt) <= 0) {
            showToast('Enter an amount');
            return;
        }

        // Check if this is a wrap/unwrap operation
        const isWrap = selectedFrom.symbol === 'SIDRA' && selectedTo.symbol === 'WSIDRA';
        const isUnwrap = selectedFrom.symbol === 'WSIDRA' && selectedTo.symbol === 'SIDRA';

        if (isWrap) {
            await wrapSIDRA();
            return;
        } else if (isUnwrap) {
            await unwrapSIDRA();
            return;
        }

        try {
            // Handle approval first if needed
            if (needsApproval && selectedFrom.address !== 'SIDRA_NATIVE') {
                setStatus('Approving token...');
                const btn = $('swapBtn');
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner"></span>Approving...';

                const amountIn = ethers.utils.parseUnits(fromAmt, selectedFrom.decimals);
                const tokenContract = new ethers.Contract(selectedFrom.address, ERC20_ABI, signer);

                const txApprove = await tokenContract.approve(ROUTER, ethers.constants.MaxUint256);
                await txApprove.wait();

                showToast('Token approved successfully');
                needsApproval = false;
                updateSwapBtn();
                return; // User needs to click swap again
            }

            setStatus('Preparing swap...');
            const btn = $('swapBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span>Swapping...';

            const amountIn = ethers.utils.parseUnits(fromAmt, selectedFrom.decimals);

            // Build path
            let path = [];
            if (selectedFrom.address === 'SIDRA_NATIVE') {
                path = [WSIDRA, selectedTo.address === 'SIDRA_NATIVE' ? WSIDRA : selectedTo.address];
            } else if (selectedTo.address === 'SIDRA_NATIVE') {
                path = [selectedFrom.address, WSIDRA];
            } else {
                path = [selectedFrom.address, selectedTo.address];
            }

            // Get quote for minimum amount out
            const amounts = await router.getAmountsOut(amountIn, path);
            const amountOutMin = amounts[amounts.length - 1].mul(10000 - slippage * 100).div(10000);

            const deadline = Math.floor(Date.now() / 1000) + 60 * 20;

            // Execute swap based on token types
            let tx;
            if (selectedFrom.address === 'SIDRA_NATIVE') {
                // SIDRA -> Token
                tx = await router.swapExactETHForTokens(
                    amountOutMin,
                    path,
                    account,
                    deadline,
                    { value: amountIn, gasLimit: 3000000 }
                );
            } else if (selectedTo.address === 'SIDRA_NATIVE') {
                // Token -> SIDRA
                tx = await router.swapExactTokensForETH(
                    amountIn,
                    amountOutMin,
                    path,
                    account,
                    deadline,
                    { gasLimit: 3000000 }
                );
            } else {
                // Token -> Token
                tx = await router.swapExactTokensForTokens(
                    amountIn,
                    amountOutMin,
                    path,
                    account,
                    deadline,
                    { gasLimit: 3000000 }
                );
            }

            $('txLink').innerHTML = `<a href="${EXPLORER}/tx/${tx.hash}" target="_blank" style="color:var(--accent)">View on Explorer</a>`;
            setStatus('Submitted — waiting confirmation...');
            await tx.wait();

            showToast('Swap completed successfully!');
            setStatus('Swap completed');

            // Reset form and update balances
            $('fromAmount').value = '';
            $('toAmount').value = '';
            await updateBalances();
            await updateDropdownBalances();

        } catch (error) {
            console.error('Swap error:', error);
            showToast('Swap failed: ' + (error.message || error));
            setStatus('Swap failed');
        } finally {
            const btn = $('swapBtn');
            btn.disabled = false;
            updateSwapBtn();
        }
    }

    // EVENT LISTENERS
    $('swapBtn').addEventListener('click', executeSwap);
    $('fromAmount').addEventListener('input', updatePriceInfo);
    $('fromAmount').addEventListener('input', updateSwapBtn);

    // Close modal when clicking outside
    window.addEventListener('click', (e) => {
        if (e.target === $('settingsModal')) {
            closeSettingsModal();
        }
    });

    // INITIALIZATION
    document.addEventListener('DOMContentLoaded', async () => {
        // Load custom tokens from localStorage
        loadCustomTokens();

        // Initialize provider for read-only operations
        try {
            provider = new ethers.providers.JsonRpcProvider(RPC);
            router = new ethers.Contract(ROUTER, ROUTER_ABI, provider);
            factory = new ethers.Contract(FACTORY, FACTORY_ABI, provider);
            wSidraContract = new ethers.Contract(WSIDRA, WSIDRA_ABI, provider);

            // Check if wallet is already connected
            if (window.ethereum && window.ethereum.selectedAddress) {
                account = window.ethereum.selectedAddress;
                connectBtn.textContent = account.substring(0,6) + '...' + account.substring(38);
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                router = new ethers.Contract(ROUTER, ROUTER_ABI, signer);
                wSidraContract = new ethers.Contract(WSIDRA, WSIDRA_ABI, signer);

                // Dapatkan data pool
                await getPoolReserves(selectedFrom, selectedTo);

                await updateBalances();
                await updateDropdownBalances();
                updateSwapBtn();
            }
        } catch (error) {
            console.error('Initialization error:', error);
        }
    });

    // Export functions to global scope
    window.wrapSIDRA = wrapSIDRA;
    window.unwrapSIDRA = unwrapSIDRA;
    window.filterTokens = filterTokens;
    window.closeSettingsModal = closeSettingsModal;
    window.updateSlippage = updateSlippage;
    window.updateDeadline = updateDeadline;
    window.toggleExpertMode = toggleExpertMode;
  </script>
</body>
</html>