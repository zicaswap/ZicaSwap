<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ZicaSwap ‚Äî Sidra Chain Pools (Sidra Chain)</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary: #1a7f5e;
      --primary-dark: #146c4d;
      --accent: #31d0aa;
      --text: #ffffff;
      --muted: rgba(255,255,255,0.12);
      --card-bg: rgba(14,42,33,0.85);
      --card-border: rgba(26,127,94,0.12);
      --glass: rgba(255,255,255,0.03);
      --warning: #ff9800;
      --danger: #f44336;
      --success: #4caf50;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Kanit',sans-serif;
      background:linear-gradient(180deg,#04140d 0%, #07261b 100%);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      min-height:100vh;
    }
    .header{background: linear-gradient(135deg,var(--primary-dark),#0f593c);padding:12px 0;position:sticky;top:0;z-index:1300;border-bottom:1px solid rgba(0,0,0,0.25);}
    .nav-container{max-width:1200px;margin:0 auto;padding:0 20px;display:flex;align-items:center;justify-content:space-between;gap:12px;position:relative;}
    .logo{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--text)}
    .logo img{width:40px;height:40px;border-radius:8px;object-fit:cover}
    .logo span{font-weight:700;font-size:18px}
    .connect-wallet{background:var(--accent);color:#052017;border:none;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer;z-index:1400;position:relative}
    .menu-dot-btn{width:40px;height:40px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text);font-size:18px;position:relative;z-index:1400;}
    .menu-dropdown{position:absolute;right:20px;top:64px;min-width:180px;background:rgba(255,255,255,0.03);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,0.04);border-radius:12px;padding:8px;box-shadow:0 12px 30px rgba(0,0,0,0.5);opacity:0;transform:translateY(-6px);pointer-events:none;transition:all .18s ease;z-index:1600;}
    .menu-dropdown.show{opacity:1;transform:translateY(0);pointer-events:auto}
    .menu-item{padding:10px;border-radius:10px;color:var(--text);cursor:pointer;font-weight:600}
    .menu-item:hover{background:rgba(255,255,255,0.02)}
    .menu-sep{height:1px;background:rgba(255,255,255,0.03);margin:6px 0;border-radius:2px}
    .main{max-width:1200px;margin:32px auto;padding:0 20px}
    .swap-row{display:flex;gap:24px;align-items:flex-start}
    @media (max-width:980px){.swap-row{flex-direction:column;padding-bottom:40px}}
    .card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:16px;padding:18px;flex:1;max-width:540px;box-shadow:0 10px 30px rgba(0,0,0,0.55)}
    .card-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .title{font-size:20px;font-weight:700}
    .token-block{background:rgba(255,255,255,0.02);border-radius:12px;padding:10px;margin-bottom:12px;border:1px solid transparent}
    .token-block:focus-within{border-color:var(--primary)}
    .input-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .label{color:#cfece0;font-size:13px}
    .balance{color:var(--muted);font-size:13px;cursor:pointer}
    .row{display:flex;gap:12px;align-items:center}
    .select-wrap{position:relative;min-width:140px}
    .select{display:flex;align-items:center;gap:8px;padding:8px;border-radius:10px;background:rgba(0,0,0,0.12);cursor:pointer;border:1px solid rgba(255,255,255,0.02);min-width:120px;z-index:1500}
    .select img{width:34px;height:34px;border-radius:8px;object-fit:cover}
    .symbol{font-weight:700}
    .amount-wrap{flex:1;display:flex;flex-direction:column;align-items:flex-end;min-width:0}
    .amount{width:100%;background:transparent;border:none;color:var(--text);font-size:22px;font-weight:700;text-align:right;padding:6px 0;outline:none}
    .amount::placeholder{color:var(--muted)}
    .meta{display:flex;justify-content:space-between;align-items:center;gap:8px;width:100%;margin-top:8px}
    .usd{color:var(--muted);font-size:13px;white-space:nowrap}
    .max{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:6px 10px;border-radius:10px;font-weight:700;color:var(--primary);cursor:pointer;font-size:13px}
    .max:disabled{opacity:0.5;cursor:not-allowed}
    .token-list{position:absolute;top:calc(100% + 8px);left:0;background:rgba(255,255,255,0.03);backdrop-filter:blur(6px);border-radius:12px;padding:8px;border:1px solid rgba(255,255,255,0.04);min-width:320px;max-height:320px;overflow:auto;z-index:2200;box-shadow:0 12px 32px rgba(0,0,0,0.5);pointer-events:auto}
    .token-search input{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text);margin-bottom:8px}
    .token-option{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;cursor:pointer}
    .token-option:hover{background:rgba(255,255,255,0.02)}
    .token-addr{font-size:12px;color:var(--muted)}
    .controls{text-align:center;margin:8px 0}
    .flip{background:var(--primary-dark);border:none;color:white;width:44px;height:44px;border-radius:50%;cursor:pointer;font-size:18px}
    .price{background:rgba(255,255,255,0.02);padding:10px;border-radius:10px;margin-top:12px}
    .info{display:flex;justify-content:space-between;color:var(--muted);font-size:13px;padding:6px 0}
    .primary{width:100%;background:var(--primary);border:none;padding:12px;border-radius:12px;font-weight:800;font-size:16px;cursor:pointer;margin-top:12px}
    .primary:disabled{opacity:0.5;cursor:not-allowed}
    .secondary{width:100%;background:transparent;border:1px solid var(--primary);padding:12px;border-radius:12px;font-weight:800;font-size:16px;cursor:pointer;margin-top:12px;color:var(--primary)}
    .spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,0.12);border-top-color:var(--text);border-radius:50%;animation:spin 1s linear infinite;vertical-align:middle;margin-right:8px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .panel{flex:1;min-width:260px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:12px;padding:16px}
    .panel h4{font-weight:700;margin-bottom:10px}
    .panel-row{display:flex;justify-content:space-between;color:var(--muted);padding:8px 0}
    footer{margin-top:28px;text-align:center;padding:20px;color:var(--muted);font-size:13px}

    .liquidity-info{background:rgba(255,255,255,0.02);padding:12px;border-radius:12px;margin-top:16px}
    .liquidity-info h4{font-weight:600;margin-bottom:8px;font-size:15px}
    .liquidity-info p{color:var(--muted);font-size:13px;line-height:1.4;margin-bottom:8px}
    .pool-share{display:flex;justify-content:space-between;margin-top:12px}
    .pool-share .label{color:var(--muted)}
    .pool-share .value{font-weight:600}
    .add-icon{display:flex;align-items:center;justify-content:center;margin:12px 0}
    .add-icon div{width:24px;height:24px;border-radius:50%;background:var(--primary-dark);display:flex;align-items:center;justify-content:center;font-size:16px}
    .tabs{display:flex;gap:8px;margin-bottom:16px}
    .tab{flex:1;padding:10px;text-align:center;background:rgba(255,255,255,0.02);border-radius:10px;cursor:pointer;font-weight:600;transition:all 0.2s ease}
    .tab.active{background:var(--primary)}
    .tab:hover:not(.active){background:rgba(255,255,255,0.04)}

    .pool-card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:12px;padding:16px;margin-bottom:12px}
    .pool-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .pool-tokens{display:flex;align-items:center;gap:8px}
    .pool-token{display:flex;align-items:center;gap:6px}
    .pool-token img{width:24px;height:24px;border-radius:6px}
    .pool-metrics{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    .metric{text-align:center}
    .metric-value{font-weight:700;font-size:16px;margin-bottom:4px}
    .metric-label{color:var(--muted);font-size:12px}
    .pool-actions{display:flex;gap:8px;margin-top:12px}
    .pool-action{flex:1;padding:8px;border-radius:8px;text-align:center;font-weight:600;cursor:pointer;font-size:13px}
    .pool-add{background:var(--primary)}
    .pool-remove{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1)}

    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:3000;display:flex;align-items:center;justify-content:center;padding:20px}
    .modal{background:var(--card-bg);border:1px solid var(--card-border);border-radius:16px;padding:20px;max-width:400px;width:100%}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .modal-title{font-size:18px;font-weight:700}
    .close-modal{background:transparent;border:none;color:var(--text);font-size:20px;cursor:pointer}
    .percentage-buttons{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;margin:16px 0}
    .percentage-btn{padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.05);color:var(--text);cursor:pointer;font-weight:600;text-align:center}
    .percentage-btn.active{background:var(--primary);border-color:var(--primary)}
    .remove-amounts{margin:16px 0}
    .remove-amount{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.05)}
    .remove-amount:last-child{border-bottom:none}
    .slippage-info{background:rgba(255,152,0,0.1);border:1px solid rgba(255,152,0,0.3);border-radius:8px;padding:12px;margin:12px 0;font-size:13px}
    .slippage-info .warning-header{display:flex;align-items:center;gap:8px;color:var(--warning);font-weight:600;margin-bottom:6px}

    .add-token-btn{display:flex;align-items:center;justify-content:center;gap:8px;padding:12px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px dashed rgba(255,255,255,0.1);cursor:pointer;margin-top:8px;transition:all 0.2s ease}
    .add-token-btn:hover{background:rgba(255,255,255,0.04);border-color:var(--primary)}
    .add-token-btn span{font-weight:600;font-size:14px}
    .add-token-form{background:rgba(255,255,255,0.02);border-radius:12px;padding:16px;margin-top:12px;border:1px solid rgba(255,255,255,0.05)}
    .form-group{margin-bottom:12px}
    .form-label{display:block;color:var(--muted);font-size:13px;margin-bottom:6px}
    .form-input{width:100%;padding:10px;border-radius:8px;background:rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.05);color:var(--text);font-size:14px}
    .form-input:focus{outline:none;border-color:var(--primary)}
    .form-actions{display:flex;gap:8px;margin-top:16px}
    .btn{flex:1;padding:10px;border-radius:8px;font-weight:600;cursor:pointer;border:none;font-size:14px}
    .btn-primary{background:var(--primary);color:white}
    .btn-secondary{background:rgba(255,255,255,0.05);color:var(--text)}
    .warning-box{background:rgba(255,152,0,0.1);border:1px solid rgba(255,152,0,0.3);border-radius:8px;padding:12px;margin-top:12px}
    .warning-header{display:flex;align-items:center;gap:8px;color:var(--warning);font-weight:600;margin-bottom:6px}
    .warning-text{color:var(--warning);font-size:13px;line-height:1.4}
    .token-verified{color:var(--accent);font-size:11px;margin-left:6px}
    .token-imported{color:var(--primary);font-size:11px;margin-left:6px}
    .token-warning{color:var(--warning);font-size:11px;margin-left:6px}

    .tvl-stats{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
    .tvl-stat{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;text-align:center}
    .tvl-value{font-weight:700;font-size:18px;color:var(--accent);margin-bottom:4px}
    .tvl-label{color:var(--muted);font-size:12px}

    .empty-state{text-align:center;padding:40px 20px;color:var(--muted)}
    .empty-icon{font-size:48px;margin-bottom:16px;opacity:0.5}

    @media (max-width:520px){
      .select img{width:28px;height:28px}.amount{font-size:20px}.menu-dropdown{right:12px;left:auto}.token-list{min-width:260px;left:0;right:0}
      .pool-metrics{grid-template-columns:1fr}.tvl-stats{grid-template-columns:1fr}
    }
  </style>
</head>
<body>

  <header class="header">
    <div class="nav-container">
      <a class="logo" href="swap.html">
        <img src="https://zicaswap.xyz/assets/zica.png" alt="ZicaSwap">
        <span>ZicaSwap</span>
      </a>

      <div style="display:flex;align-items:center;gap:8px;position:relative;">
        <button id="menuBtn" class="menu-dot-btn" title="Menu">‚ãÆ</button>
        <div id="menuDropdown" class="menu-dropdown" aria-hidden="true">
          <div class="menu-item" data-href="swap.html">Swap</div>
          <div class="menu-item" data-href="liquidity.html">Liquidity</div>
          <div class="menu-item" data-href="tokencreator.html">Create Token</div>
          <div class="menu-item" data-href="staking.html">Stake</div>
          <div class="menu-sep"></div>
          <div class="menu-item" data-href="docs.html">Docs</div>
        </div>

        <button id="connectBtn" class="connect-wallet">Connect Wallet</button>
      </div>
    </div>
  </header>

  <main class="main">
    <div class="swap-row">
      <section class="card" aria-label="Liquidity">
        <div class="card-head">
          <div class="title" id="mainTitle">Liquidity</div>
        </div>

        <div class="tvl-stats">
          <div class="tvl-stat">
            <div class="tvl-value" id="totalTVL">$---</div>
            <div class="tvl-label">Total Value Locked</div>
          </div>
          <div class="tvl-stat">
            <div class="tvl-value" id="totalPairs">--</div>
            <div class="tvl-label">Active Pairs</div>
          </div>
        </div>

        <div class="tabs">
          <div class="tab active" id="myPoolsTab">My Pools</div>
          <div class="tab" id="addTab">Add Liquidity</div>
          <div class="tab" id="importTab">Import Pool</div>
        </div>

        <div id="myPoolsView">
          <div id="poolsList"></div>
          <div class="empty-state" id="noPoolsMessage" style="display:none">
            <div class="empty-icon">üèä‚Äç‚ôÇÔ∏è</div>
            <h4>No Liquidity Pools Found</h4>
            <p>You don't have any liquidity positions yet.</p>
            <button class="primary" style="margin-top:16px" onclick="switchToAddView()">Add Liquidity</button>
          </div>
        </div>

        <div id="addLiquidityView" style="display:none">
          <div class="token-block" id="fromBlock">
            <div class="input-head">
              <div class="label">Token 1</div>
              <div id="fromBalance" class="balance">‚Äî</div>
            </div>
            <div class="row">
              <div class="select-wrap">
                <div id="fromSelect" class="select" tabindex="0" aria-haspopup="listbox" aria-expanded="false">
                  <img id="fromLogo" src="https://zicaswap.xyz/assets/sidra.png" alt="">
                  <div style="min-width:0">
                    <div id="fromSymbol" class="symbol">SIDRA</div>
                  </div>
                  <div style="margin-left:auto;color:var(--muted)">‚ñº</div>
                </div>
                <div id="fromList" class="token-list" style="display:none"></div>
              </div>
              <div class="amount-wrap">
                <input id="fromAmount" class="amount" placeholder="0.0" inputmode="decimal" autocomplete="off">
                <div class="meta">
                  <div id="fromUsd" class="usd">‚Äî</div>
                  <button id="btnMax" class="max" disabled>MAX</button>
                </div>
              </div>
            </div>
          </div>

          <div class="add-icon">
            <div>+</div>
          </div>

          <div class="token-block" id="toBlock">
            <div class="input-head">
              <div class="label">Token 2</div>
              <div id="toBalance" class="balance">‚Äî</div>
            </div>
            <div class="row">
              <div class="select-wrap">
                <div id="toSelect" class="select" tabindex="0" aria-haspopup="listbox" aria-expanded="false">
                  <img id="toLogo" src="https://zicaswap.xyz/assets/usdt.png" alt="">
                  <div style="min-width:0">
                    <div id="toSymbol" class="symbol">USDT</div>
                  </div>
                  <div style="margin-left:auto;color:var(--muted)">‚ñº</div>
                </div>
                <div id="toList" class="token-list" style="display:none"></div>
              </div>
              <div class="amount-wrap">
                <input id="toAmount" class="amount" placeholder="0.0" inputmode="decimal" autocomplete="off">
                <div class="meta">
                  <div id="toUsd" class="usd">‚Äî</div>
                  <button class="max" style="visibility:hidden">MAX</button>
                </div>
              </div>
            </div>
          </div>

          <div class="liquidity-info">
            <h4>Liquidity Information</h4>
            <p id="liquidityDescription">You are the first liquidity provider for this pair. The ratio of tokens you add will set the price of this pool.</p>
            <div class="pool-share">
              <div class="label">Your pool share:</div>
              <div class="value" id="poolShareValue">0%</div>
            </div>
          </div>

          <button id="actionBtn" class="primary">Connect Wallet</button>
        </div>

        <div id="importPoolView" style="display:none">
          <div class="add-token-form">
            <div class="form-group">
              <label class="form-label">Token A Address</label>
              <input type="text" class="form-input" id="tokenAInput" placeholder="0x..." />
            </div>
            <div class="form-group">
              <label class="form-label">Token B Address</label>
              <input type="text" class="form-input" id="tokenBInput" placeholder="0x..." />
            </div>
            <div class="warning-box">
              <div class="warning-header">
                <span>‚ö†Ô∏è</span>
                <span>Security Warning</span>
              </div>
              <div class="warning-text">
                Anyone can create pools with any tokens. Verify the token addresses before importing. 
                Fake pools may look similar to legitimate ones. Always double-check from official sources.
              </div>
            </div>
            <div class="form-actions">
              <button class="btn btn-secondary" onclick="switchToMyPoolsView()">Cancel</button>
              <button class="btn btn-primary" onclick="importPool()">Import Pool</button>
            </div>
          </div>
        </div>

        <div style="margin-top:12px;color:var(--muted);font-size:13px;text-align:center">
          <div id="status">Ready</div>
          <div id="txLink" style="margin-top:6px;font-size:12px;word-break:break-all"></div>
        </div>
      </section>

      <aside class="panel" aria-label="Info">
        <h4 id="panelTitle">Pool Information</h4>
        <div class="panel-row"><div>Pooled <span id="tokenASymbol">SIDRA</span></div><div id="pooledTokenA">‚Äî</div></div>
        <div class="panel-row"><div>Pooled <span id="tokenBSymbol">USDT</span></div><div id="pooledTokenB">‚Äî</div></div>
        <div class="panel-row"><div>Your pool tokens</div><div id="poolTokens">‚Äî</div></div>
        <div class="panel-row"><div>Your pool share</div><div id="poolSharePercent">0%</div></div>

        <h4 style="margin-top:14px">Pool Stats</h4>
        <div class="panel-row"><div><span id="tokenASymbol2">SIDRA</span> per <span id="tokenBSymbol2">USDT</span></div><div id="priceA">‚Äî</div></div>
        <div class="panel-row"><div><span id="tokenBSymbol3">USDT</span> per <span id="tokenASymbol3">SIDRA</span></div><div id="priceB">‚Äî</div></div>
        <div class="panel-row"><div>Total Liquidity</div><div id="totalLiquidity">$‚Äî</div></div>
        <div class="panel-row"><div>24h Volume</div><div id="dailyVolume">$‚Äî</div></div>

        <h4 style="margin-top:14px">Quick Add Liquidity</h4>
        <button class="pool-action pool-add" onclick="quickAddLiquidity('SIDRA', 'USDT')">SIDRA-USDT</button>
        <button class="pool-action pool-add" onclick="quickAddLiquidity('SIDRA', 'ZICA')" style="margin-top:8px">SIDRA-ZICA</button>
        <button class="pool-action pool-add" onclick="quickAddLiquidity('ZICA', 'USDT')" style="margin-top:8px">ZICA-USDT</button>
        <button class="pool-action pool-add" onclick="quickAddLiquidity('SIDURU', 'USDT')" style="margin-top:8px">SIDURU-USDT</button>
      </aside>
    </div>
  </main>

  <div id="removeLiquidityModal" class="modal-overlay" style="display:none">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Remove Liquidity</div>
        <button class="close-modal" onclick="closeRemoveModal()">√ó</button>
      </div>

      <div id="removePoolInfo"></div>

      <div class="percentage-buttons">
        <button class="percentage-btn" data-percent="25" onclick="setRemovePercentage(25)">25%</button>
        <button class="percentage-btn" data-percent="50" onclick="setRemovePercentage(50)">50%</button>
        <button class="percentage-btn" data-percent="75" onclick="setRemovePercentage(75)">75%</button>
        <button class="percentage-btn" data-percent="100" onclick="setRemovePercentage(100)">100%</button>
      </div>

      <div class="remove-amounts">
        <div class="remove-amount">
          <span id="removeTokenASymbol">Token A</span>
          <span id="removeTokenAAmount">0</span>
        </div>
        <div class="remove-amount">
          <span id="removeTokenBSymbol">Token B</span>
          <span id="removeTokenBAmount">0</span>
        </div>
      </div>

      <div class="slippage-info">
        <div class="warning-header">
          <span>‚ö†Ô∏è</span>
          <span>Slippage Tolerance</span>
        </div>
        <div class="warning-text">
          Using 5% slippage tolerance to prevent INSUFFICIENT_A_AMOUNT errors. You will receive at least 95% of the estimated amounts.
        </div>
      </div>

      <button id="confirmRemoveBtn" class="primary" onclick="confirmRemoveLiquidity()">Remove Liquidity</button>
    </div>
  </div>

  <footer>¬© 2025 ZicaSwap. Built on Sidra Chain</footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.1/ethers.umd.min.js"></script>
  <script>
  // CONFIG - Sidra Chain
  const ROUTER = '0xECd5BFE9044640D19dFd2Cdd4F360551d8E3E34C';
  const WSIDRA = '0x00EDdD9621Fb08436d0331c149D1690909a5906d'; // Wrapped Sidra (WETH equivalent)
  const FACTORY = '0x7Cba03E40FCE39c55AC3280E4eedB9c5d733D35D';
  const ZICA = '0x82741ff5937933244eb562A4b396f8079F1de914'; // Zica token
  const USDT = '0xF1815bd50389c46847f0Bda824eC8da914045D14';
  const SIDURU = '0x6043921876841e8f421a4f9E748825DC6C430255'; // SIDURU (SDR token)
  const RPC = 'https://node.sidrachain.com';
  const EXPLORER = 'https://ledger.sidrachain.com';
  const CHAIN_ID_HEX = '0x5C8'; // Sesuaikan dengan chain ID Sidra Chain

  // PERBAIKAN: Gunakan DexScreener untuk harga real-time
  const DEXSCREENER_API = 'https://api.dexscreener.com/latest/dex/tokens/';
  
  // Token addresses untuk DexScreener
  const DEXSCREENER_TOKENS = {
    'SIDRA': WSIDRA, // Gunakan WSIDRA untuk SIDRA
    'ZICA': ZICA,
    'SIDURU': SIDURU,
    'USDT': USDT
  };

  const ROUTER_ABI = [
    'function getAmountsOut(uint amountIn, address[] memory path) public view returns (uint[] memory amounts)',
    'function addLiquidity(address tokenA, address tokenB, uint amountADesired, uint amountBDesired, uint amountAMin, uint amountBMin, address to, uint deadline) external returns (uint amountA, uint amountB, uint liquidity)',
    'function addLiquidityETH(address token, uint amountTokenDesired, uint amountTokenMin, uint amountETHMin, address to, uint deadline) external payable returns (uint amountToken, uint amountETH, uint liquidity)',
    'function removeLiquidity(address tokenA, address tokenB, uint liquidity, uint amountAMin, uint amountBMin, address to, uint deadline) external returns (uint amountA, uint amountB)',
    'function removeLiquidityETH(address token, uint liquidity, uint amountTokenMin, uint amountETHMin, address to, uint deadline) external returns (uint amountToken, uint amountETH)'
  ];

  const FACTORY_ABI = [
    'function getPair(address tokenA, address tokenB) external view returns (address pair)',
    'function createPair(address tokenA, address tokenB) external returns (address pair)',
    'function allPairsLength() external view returns (uint)',
    'function allPairs(uint) external view returns (address)'
  ];

  const PAIR_ABI = [
    'function getReserves() view returns (uint112,uint112,uint32)',
    'function token0() view returns (address)',
    'function token1() view returns (address)',
    'function totalSupply() view returns (uint256)',
    'function balanceOf(address) view returns (uint256)',
    'function symbol() view returns (string)',
    'function approve(address spender, uint256 amount) external returns (bool)',
    'function allowance(address owner, address spender) external view returns (uint256)'
  ];

  const ERC20_ABI = [
    'function balanceOf(address account) external view returns (uint256)',
    'function transfer(address to, uint256 amount) external returns (bool)',
    'function approve(address spender, uint256 amount) external returns (bool)',
    'function allowance(address owner, address spender) external view returns (uint256)',
    'function decimals() external view returns (uint8)',
    'function symbol() external view returns (string memory)',
    'function name() external view returns (string memory)'
  ];

  // STATE
  let provider = null;
  let signer = null;
  let account = null;
  let router = null;
  let factory = null;
  let currentPair = null;
  let userPools = [];
  let currentRemovePool = null;
  let currentRemovePercentage = 0;
  let tokenPrices = {};

  const DEFAULT_TOKENS = [
    { symbol: 'SIDRA', address: 'SIDRA_NATIVE', logo: 'https://zicaswap.xyz/assets/sidra.png', decimals: 18, verified: true},
    { symbol: 'WSIDRA', address: WSIDRA, logo: 'https://zicaswap.xyz/assets/wsidra.png', decimals: 18, verified: true},
    { symbol: 'USDT', address: USDT, logo: 'https://zicaswap.xyz/assets/usdt.png', decimals: 6, verified: true},
    { symbol: 'ZICA', address: ZICA, logo: 'https://zicaswap.xyz/assets/zica.png', decimals: 18, verified: true},
    { symbol: 'SIDURU', address: SIDURU, logo: 'https://zicaswap.xyz/assets/siduru.png', decimals: 18, verified: true}
  ];

  let tokens = DEFAULT_TOKENS.slice();
  let selectedFrom = tokens[0];
  let selectedTo = tokens[2];

  // State management
  let isCalculatingA = false;
  let isCalculatingB = false;

  const $ = id => document.getElementById(id);

  function showToast(msg, t = 2400){
    const el = document.createElement('div'); el.className = 'toast'; el.textContent = msg;
    el.style.position = 'fixed'; el.style.bottom = '20px'; el.style.left = '50%'; el.style.transform = 'translateX(-50%)';
    el.style.background = 'var(--primary)'; el.style.color = 'white'; el.style.padding = '12px 20px';
    el.style.borderRadius = '8px'; el.style.zIndex = '9999'; el.style.fontWeight = '600';
    el.style.opacity = '0'; el.style.transition = 'opacity .18s';
    document.body.appendChild(el);
    setTimeout(()=> el.style.opacity = '1', 10);
    setTimeout(()=> { el.style.opacity = '0'; setTimeout(()=> el.remove(), 300); }, t);
  }

  function setStatus(s){ $('status').textContent = s }

  // =============================================
  // HARGA REAL DARI DEXSCREENER
  // =============================================

  async function getRealTokenPrice(tokenSymbol) {
    if (tokenPrices[tokenSymbol] && (Date.now() - tokenPrices[tokenSymbol].timestamp) < 30000) {
      return tokenPrices[tokenSymbol].price;
    }

    try {
      const tokenAddress = DEXSCREENER_TOKENS[tokenSymbol];
      if (!tokenAddress) {
        console.warn(`No DexScreener address for ${tokenSymbol}`);
        return 0;
      }

      const response = await fetch(`${DEXSCREENER_API}${tokenAddress}`);
      const data = await response.json();

      if (data && data.pairs && data.pairs.length > 0) {
        const price = parseFloat(data.pairs[0].priceUsd);
        
        if (price && price > 0) {
          tokenPrices[tokenSymbol] = {
            price: price,
            timestamp: Date.now()
          };
          return price;
        }
      }
    } catch (error) {
      console.error(`Error fetching DexScreener price for ${tokenSymbol}:`, error);
    }

    return 0;
  }

  // =============================================
  // AUTO-CALCULATION HANYA UNTUK POOL YANG SUDAH ADA
  // =============================================

  async function calculateOptimalAmountB() {
    if (!provider || !account || isCalculatingB) return;

    const fromAmt = $('fromAmount').value;
    if (!fromAmt || parseFloat(fromAmt) <= 0) {
      return;
    }

    isCalculatingB = true;

    try {
      const tokenA = selectedFrom.address === 'SIDRA_NATIVE' ? WSIDRA : selectedFrom.address;
      const tokenB = selectedTo.address === 'SIDRA_NATIVE' ? WSIDRA : selectedTo.address;

      const pairAddress = await factory.getPair(tokenA, tokenB);

      // HANYA untuk pool yang sudah ada
      if (pairAddress && pairAddress !== '0x0000000000000000000000000000000000000000') {
        const pairContract = new ethers.Contract(pairAddress, PAIR_ABI, provider);
        const [reserve0, reserve1] = await pairContract.getReserves();
        const token0 = await pairContract.token0();

        let reserveA, reserveB;

        if (token0.toLowerCase() === tokenA.toLowerCase()) {
          reserveA = reserve0;
          reserveB = reserve1;
        } else {
          reserveA = reserve1;
          reserveB = reserve0;
        }

        if (reserveA.isZero() || reserveB.isZero()) {
          isCalculatingB = false;
          return;
        }

        const amountADesired = ethers.utils.parseUnits(fromAmt, selectedFrom.decimals);
        const amountBOptimal = amountADesired.mul(reserveB).div(reserveA);

        if (amountBOptimal.isZero()) {
          isCalculatingB = false;
          return;
        }

        const toAmountFormatted = parseFloat(ethers.utils.formatUnits(amountBOptimal, selectedTo.decimals));
        $('toAmount').value = toAmountFormatted.toFixed(selectedTo.decimals > 6 ? 6 : selectedTo.decimals);
      }
      // Untuk pool baru: TIDAK ADA auto-calculation

      updateUSDValues();
      updateActionBtn();
    } catch (error) {
      console.error('Error calculating optimal amount B:', error);
    } finally {
      setTimeout(() => { isCalculatingB = false; }, 100);
    }
  }

  async function calculateOptimalAmountA() {
    if (!provider || !account || isCalculatingA) return;

    const toAmt = $('toAmount').value;
    if (!toAmt || parseFloat(toAmt) <= 0) {
      return;
    }

    isCalculatingA = true;

    try {
      const tokenA = selectedFrom.address === 'SIDRA_NATIVE' ? WSIDRA : selectedFrom.address;
      const tokenB = selectedTo.address === 'SIDRA_NATIVE' ? WSIDRA : selectedTo.address;

      const pairAddress = await factory.getPair(tokenA, tokenB);

      // HANYA untuk pool yang sudah ada
      if (pairAddress && pairAddress !== '0x0000000000000000000000000000000000000000') {
        const pairContract = new ethers.Contract(pairAddress, PAIR_ABI, provider);
        const [reserve0, reserve1] = await pairContract.getReserves();
        const token0 = await pairContract.token0();

        let reserveA, reserveB;

        if (token0.toLowerCase() === tokenA.toLowerCase()) {
          reserveA = reserve0;
          reserveB = reserve1;
        } else {
          reserveA = reserve1;
          reserveB = reserve0;
        }

        if (reserveA.isZero() || reserveB.isZero()) {
          isCalculatingA = false;
          return;
        }

        const amountBDesired = ethers.utils.parseUnits(toAmt, selectedTo.decimals);
        const amountAOptimal = amountBDesired.mul(reserveA).div(reserveB);

        if (amountAOptimal.isZero()) {
          isCalculatingA = false;
          return;
        }

        const fromAmountFormatted = parseFloat(ethers.utils.formatUnits(amountAOptimal, selectedFrom.decimals));
        $('fromAmount').value = fromAmountFormatted.toFixed(selectedFrom.decimals > 6 ? 6 : selectedFrom.decimals);
      }
      // Untuk pool baru: TIDAK ADA auto-calculation

      updateUSDValues();
      updateActionBtn();
    } catch (error) {
      console.error('Error calculating optimal amount A:', error);
    } finally {
      setTimeout(() => { isCalculatingA = false; }, 100);
    }
  }

  // =============================================
  // VIEW MANAGEMENT
  // =============================================

  function switchToMyPoolsView() {
    $('myPoolsTab').classList.add('active');
    $('addTab').classList.remove('active');
    $('importTab').classList.remove('active');
    $('myPoolsView').style.display = 'block';
    $('addLiquidityView').style.display = 'none';
    $('importPoolView').style.display = 'none';
    $('mainTitle').textContent = 'My Liquidity Pools';
    $('panelTitle').textContent = 'Pool Information';
    loadUserPools();
  }

  function switchToAddView() {
    $('addTab').classList.add('active');
    $('myPoolsTab').classList.remove('active');
    $('importTab').classList.remove('active');
    $('myPoolsView').style.display = 'none';
    $('addLiquidityView').style.display = 'block';
    $('importPoolView').style.display = 'none';
    $('mainTitle').textContent = 'Add Liquidity';
    $('panelTitle').textContent = 'Pool Information';
    
    // Reset input values
    $('fromAmount').value = '';
    $('toAmount').value = '';
    
    updateLiquidityInfo();
  }

  function switchToImportView() {
    $('importTab').classList.add('active');
    $('myPoolsTab').classList.remove('active');
    $('addTab').classList.remove('active');
    $('myPoolsView').style.display = 'none';
    $('addLiquidityView').style.display = 'none';
    $('importPoolView').style.display = 'block';
    $('mainTitle').textContent = 'Import Pool';
    $('panelTitle').textContent = 'Pool Information';
  }

  // Initialize tabs
  $('myPoolsTab').addEventListener('click', switchToMyPoolsView);
  $('addTab').addEventListener('click', switchToAddView);
  $('importTab').addEventListener('click', switchToImportView);

  // =============================================
  // MENU & DROPDOWNS
  // =============================================

  const menuBtn = $('menuBtn');
  const menuDropdown = $('menuDropdown');
  menuBtn.addEventListener('click', (e)=>{ e.stopPropagation(); menuDropdown.classList.toggle('show'); });
  menuDropdown.querySelectorAll('.menu-item').forEach(it=>{ 
    it.addEventListener('click', ()=> { 
      const href = it.getAttribute('data-href');
      if (href) {
        window.location.href = href;
      }
    }); 
  });
  document.addEventListener('click', ()=> menuDropdown.classList.remove('show'));

  function buildTokenListHtml(type){
    const listEl = (type==='from') ? $('fromList') : $('toList');
    listEl.innerHTML = '';
    const search = document.createElement('div'); search.className = 'token-search';
    search.innerHTML = `<input placeholder="Search token..." oninput="filterTokens('${type}', this.value)" />`;
    listEl.appendChild(search);
    const header = document.createElement('div'); header.style.color = 'var(--muted)'; header.style.fontSize='13px'; header.style.marginBottom = '8px'; header.textContent = `Select Token (${tokens.length})`;
    listEl.appendChild(header);
    for(const t of tokens){
      const opt = document.createElement('div'); opt.className = 'token-option'; opt.setAttribute('data-addr', t.address);
      let statusBadge = '';
      if (t.verified) {
        statusBadge = '<span class="token-verified">‚úì Verified</span>';
      } else if (t.custom) {
        statusBadge = '<span class="token-imported">Imported</span>';
      } else if (t.warning) {
        statusBadge = '<span class="token-warning">‚ö†Ô∏è Unknown</span>';
      }

      opt.innerHTML = `<img src="${t.logo}" style="width:28px;height:28px;border-radius:6px;margin-right:8px"/>
                       <div style="flex:1;min-width:0">
                         <div style="font-weight:700">${t.symbol} ${statusBadge}</div>
                         <div class="token-addr">${t.address === 'SIDRA_NATIVE' ? 'Native Token' : (t.address.substring(0,6)+'...'+t.address.substring(38))}</div>
                       </div>
                       <div id="bal-${t.symbol}" style="color:var(--muted);font-size:13px">‚Äî</div>`;
      opt.addEventListener('click', (e)=>{ e.stopPropagation(); selectToken(type, t); });
      listEl.appendChild(opt);
    }

    const addTokenBtn = document.createElement('div');
    addTokenBtn.className = 'add-token-btn';
    addTokenBtn.innerHTML = '<span>+ Add Custom Token</span>';
    addTokenBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      showAddTokenForm(type);
    });
    listEl.appendChild(addTokenBtn);

    if(tokens.length===0){ const no = document.createElement('div'); no.className='token-addr'; no.style.padding='12px'; no.textContent='No tokens'; listEl.appendChild(no); }
    listEl.style.display = 'block'; listEl.style.pointerEvents = 'auto';
  }

  function showAddTokenForm(type) {
    const listEl = (type==='from') ? $('fromList') : $('toList');

    if (listEl.querySelector('.add-token-form')) {
      return;
    }

    const form = document.createElement('div');
    form.className = 'add-token-form';
    form.innerHTML = `
      <div class="form-group">
        <label class="form-label">Token Contract Address</label>
        <input type="text" class="form-input" id="tokenAddressInput" placeholder="0x..." />
      </div>
      <div class="warning-box">
        <div class="warning-header">
          <span>‚ö†Ô∏è</span>
          <span>Security Warning</span>
        </div>
        <div class="warning-text">
          Anyone can create ERC-20 tokens. Verify the token contract address before adding it. 
          Fake tokens may look similar to legitimate ones. Always double-check the contract address from official sources.
        </div>
      </div>
      <div class="form-actions">
        <button class="btn btn-secondary" id="cancelAddToken">Cancel</button>
        <button class="btn btn-primary" id="importToken">Import Token</button>
      </div>
    `;

    listEl.appendChild(form);

    setTimeout(() => {
      const input = form.querySelector('#tokenAddressInput');
      if (input) input.focus();
    }, 100);

    form.querySelector('#cancelAddToken').addEventListener('click', (e) => {
      e.stopPropagation();
      form.remove();
    });

    form.querySelector('#importToken').addEventListener('click', (e) => {
      e.stopPropagation();
      importCustomToken(type, form.querySelector('#tokenAddressInput').value);
    });

    form.querySelector('#tokenAddressInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.stopPropagation();
        importCustomToken(type, form.querySelector('#tokenAddressInput').value);
      }
    });
  }

  async function importCustomToken(type, address) {
    if (!address || address.trim() === '') {
      showToast('Please enter a token address');
      return;
    }

    if (!/^0x[a-fA-F0-9]{40}$/.test(address.trim())) {
      showToast('Invalid token address format');
      return;
    }

    const existingToken = tokens.find(t => 
      t.address.toLowerCase() === address.trim().toLowerCase()
    );

    if (existingToken) {
      showToast('Token already in list');
      selectToken(type, existingToken);
      return;
    }

    try {
      setStatus('Importing token...');

      if (!provider) {
        provider = new ethers.providers.JsonRpcProvider(RPC);
      }

      const tokenContract = new ethers.Contract(address, ERC20_ABI, provider);

      const [symbol, decimals] = await Promise.all([
        tokenContract.symbol(),
        tokenContract.decimals()
      ]);

      const newToken = {
        symbol: symbol,
        address: address,
        decimals: decimals,
        logo: 'https://zicaswap.xyz/assets/unknown.png',
        custom: true,
        verified: false
      };

      tokens.push(newToken);
      saveCustomTokens();
      selectToken(type, newToken);
      buildTokenListHtml(type);

      showToast(`Token ${symbol} imported successfully`);
      setStatus('Token imported');

    } catch (error) {
      console.error('Error importing token:', error);
      showToast('Failed to import token. Check the address and try again.');
      setStatus('Import failed');
    }
  }

  function saveCustomTokens() {
    const customTokens = tokens.filter(t => t.custom);
    localStorage.setItem('zicaswap_custom_tokens', JSON.stringify(customTokens));
  }

  function loadCustomTokens() {
    try {
      const stored = localStorage.getItem('zicaswap_custom_tokens');
      if (stored) {
        const customTokens = JSON.parse(stored);
        customTokens.forEach(ct => {
          if (!tokens.some(t => t.address.toLowerCase() === ct.address.toLowerCase())) {
            tokens.push(ct);
          }
        });
      }
    } catch (error) {
      console.error('Error loading custom tokens:', error);
    }
  }

  window.filterTokens = function(type, term){ 
    const listEl = (type==='from') ? $('fromList') : $('toList'); 
    const opts = listEl.querySelectorAll('.token-option'); 
    opts.forEach(o=>{ 
      const text = o.textContent.toLowerCase(); 
      const ok = text.includes((term||'').toLowerCase()); 
      o.style.display = ok ? 'flex' : 'none'; 
    }); 
  };

  $('fromSelect').addEventListener('click', (e)=>{ 
    e.stopPropagation(); 
    const el = $('fromList'); 
    if(el.style.display === 'block'){ 
      el.style.display = 'none'; 
    } else { 
      buildTokenListHtml('from'); 
      el.style.display = 'block'; 
      $('toList').style.display = 'none'; 
    } 
  });
  
  $('toSelect').addEventListener('click', (e)=>{ 
    e.stopPropagation(); 
    const el = $('toList'); 
    if(el.style.display === 'block'){ 
      el.style.display = 'none'; 
    } else { 
      buildTokenListHtml('to'); 
      el.style.display = 'block'; 
      $('fromList').style.display = 'none'; 
    } 
  });
  
  document.addEventListener('click', (e)=>{ 
    if(!e.target.closest('.select-wrap')){ 
      $('fromList').style.display = 'none'; 
      $('toList').style.display = 'none'; 
    } 
  });

  async function selectToken(type, token){
    if(type==='from'){ 
      selectedFrom = token; 
      $('fromLogo').src = token.logo; 
      $('fromSymbol').textContent = token.symbol; 
      $('fromList').style.display = 'none'; 
    } else { 
      selectedTo = token; 
      $('toLogo').src = token.logo; 
      $('toSymbol').textContent = token.symbol; 
      $('toList').style.display = 'none'; 
    }
    
    // Reset input values ketika ganti token
    $('fromAmount').value = '';
    $('toAmount').value = '';
    
    await updateBalances(); 
    await updateLiquidityInfo();
    updateActionBtn(); 
    await updateUSDValues();
  }

  // =============================================
  // WALLET & CHAIN HANDLING
  // =============================================

  const connectBtn = $('connectBtn');
  connectBtn.addEventListener('click', connectWallet);
  
  async function ensureSidraChain(){
    if(!window.ethereum) return false;
    try{
      const net = await window.ethereum.request({ method: 'eth_chainId' });
      if(net !== CHAIN_ID_HEX){
        try{
          await window.ethereum.request({ method: 'wallet_switchEthereumChain', params:[{ chainId: CHAIN_ID_HEX }] });
          return true;
        }catch(switchErr){
          if(switchErr.code === 4902){
            await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [{ chainId: CHAIN_ID_HEX, chainName: 'Sidra Chain', rpcUrls:[RPC], nativeCurrency:{name:'SIDRA',symbol:'SIDRA',decimals:18}, blockExplorerUrls:[EXPLORER] }] });
            return true;
          }
          return false;
        }
      }
      return true;
    }catch(e){
      console.error('ensureSidraChain', e);
      return false;
    }
  }

  async function connectWallet(){
    if(!window.ethereum){ alert('Please install MetaMask'); return; }
    try{
      await ensureSidraChain();
      const accounts = await window.ethereum.request({ method:'eth_requestAccounts' });
      account = accounts[0];
      provider = new ethers.providers.Web3Provider(window.ethereum);
      signer = provider.getSigner();
      router = new ethers.Contract(ROUTER, ROUTER_ABI, signer);
      factory = new ethers.Contract(FACTORY, FACTORY_ABI, provider);
      connectBtn.textContent = account.substring(0,6) + '...' + account.substring(38);
      setStatus('Connected');
      await updateBalances(); 
      await updateDropdownBalances(); 
      updateActionBtn(); 
      updateLiquidityInfo();
      loadUserPools();
      updateTVLStats();
    }catch(e){
      console.error('connectWallet', e);
      showToast('Connection failed: ' + (e.message || e));
    }
  }

  if(window.ethereum){
    window.ethereum.on('chainChanged', async (chainId) => {
      console.log('chainChanged', chainId);
      if(chainId !== CHAIN_ID_HEX){
        setStatus('Wrong chain ‚Äî switching...');
        try{ await ensureSidraChain(); setStatus('Switched to Sidra'); location.reload(); } catch(e){ setStatus('Please switch to Sidra chain in wallet'); }
      } else { setStatus('Connected to Sidra'); location.reload(); }
    });
    window.ethereum.on('accountsChanged', (accs)=>{ 
      if(accs && accs.length>0){ 
        account = accs[0]; 
        connectBtn.textContent = account.substring(0,6) + '...' + account.substring(38); 
        updateBalances(); 
        updateDropdownBalances(); 
        updateLiquidityInfo(); 
        loadUserPools(); 
        updateUSDValues(); 
      } else { 
        account = null; 
        connectBtn.textContent = 'Connect Wallet'; 
      } 
    });
  }

  // =============================================
  // BALANCES & MAX
  // =============================================

  async function updateBalances(){
    if(!provider || !account) return;
    try{
      if(selectedFrom.address === 'SIDRA_NATIVE'){
        const b = await provider.getBalance(account);
        $('fromBalance').textContent = parseFloat(ethers.utils.formatEther(b)).toFixed(4);
        $('btnMax').disabled = false;
      }else{
        const c = new ethers.Contract(selectedFrom.address, ERC20_ABI, provider);
        const b = await c.balanceOf(account);
        const d = await c.decimals();
        $('fromBalance').textContent = parseFloat(ethers.utils.formatUnits(b,d)).toFixed(4);
        $('btnMax').disabled = false;
      }
      if(selectedTo.address === 'SIDRA_NATIVE'){
        const b2 = await provider.getBalance(account);
        $('toBalance').textContent = parseFloat(ethers.utils.formatEther(b2)).toFixed(4);
      }else{
        const c2 = new ethers.Contract(selectedTo.address, ERC20_ABI, provider);
        const b2 = await c2.balanceOf(account);
        const d2 = await c2.decimals();
        $('toBalance').textContent = parseFloat(ethers.utils.formatUnits(b2,d2)).toFixed(4);
      }
    }catch(e){ console.error('updateBalances', e); }
  }

  async function updateDropdownBalances(){ 
    if(!provider || !account) return; 
    for(const t of tokens){ 
      try{ 
        let bal='0'; 
        if(t.address === 'SIDRA_NATIVE'){ 
          const b = await provider.getBalance(account); 
          bal = parseFloat(ethers.utils.formatEther(b)).toFixed(4); 
        } else { 
          const c = new ethers.Contract(t.address, ERC20_ABI, provider); 
          const b = await c.balanceOf(account); 
          const d = await c.decimals(); 
          bal = parseFloat(ethers.utils.formatUnits(b,d)).toFixed(4); 
        } 
        const el = document.querySelector(`#bal-${t.symbol}`); 
        if(el) el.textContent = bal; 
      }catch(e){ 
        const el = document.querySelector(`#bal-${t.symbol}`); 
        if(el) el.textContent = '0'; 
      } 
    } 
  }

  async function setMax(){ 
    if(!account || !provider){ await connectWallet(); return; } 
    try{ 
      if(selectedFrom.address === 'SIDRA_NATIVE'){ 
        const b = await provider.getBalance(account); 
        const usable = b.mul(95).div(100); 
        $('fromAmount').value = ethers.utils.formatEther(usable); 
      } else { 
        const c = new ethers.Contract(selectedFrom.address, ERC20_ABI, provider); 
        const b = await c.balanceOf(account); 
        const d = selectedFrom.decimals || await c.decimals(); 
        $('fromAmount').value = parseFloat(ethers.utils.formatUnits(b,d)).toFixed(d > 6 ? 6 : d); 
      } 
      updateLiquidityInfo();
      updateUSDValues();
      calculateOptimalAmountB();
    }catch(e){ console.error('setMax', e); showToast('Failed to read balance'); } 
  }
  
  $('btnMax').addEventListener('click', setMax);
  $('fromBalance').addEventListener('click', setMax);

  // =============================================
  // USD VALUES & LIQUIDITY INFO
  // =============================================

  async function updateUSDValues() {
    if (!provider) return;

    try {
      const fromAmt = $('fromAmount').value;
      const toAmt = $('toAmount').value;

      if (fromAmt && parseFloat(fromAmt) > 0) {
        const fromPrice = await getRealTokenPrice(selectedFrom.symbol);
        const fromUSD = parseFloat(fromAmt) * fromPrice;
        $('fromUsd').textContent = fromUSD > 0.01 ? `$${fromUSD.toFixed(2)}` : '< $0.01';
      } else {
        $('fromUsd').textContent = '‚Äî';
      }

      if (toAmt && parseFloat(toAmt) > 0) {
        const toPrice = await getRealTokenPrice(selectedTo.symbol);
        const toUSD = parseFloat(toAmt) * toPrice;
        $('toUsd').textContent = toUSD > 0.01 ? `$${toUSD.toFixed(2)}` : '< $0.01';
      } else {
        $('toUsd').textContent = '‚Äî';
      }
    } catch (error) {
      console.error('Error updating USD values:', error);
    }
  }

  function formatPrice(price) {
    if (price === 0) return '0';
    if (price < 0.000001) return price.toExponential(6);
    if (price < 0.001) return price.toFixed(8);
    if (price < 1) return price.toFixed(6);
    if (price < 1000) return price.toFixed(4);
    if (price < 1000000) return price.toFixed(2);
    return price.toExponential(4);
  }

  function formatUSD(amount) {
    if (amount === 0) return '$0';
    if (amount < 0.01) return '< $0.01';
    if (amount < 1000) return `$${amount.toFixed(2)}`;
    if (amount < 1000000) return `$${(amount / 1000).toFixed(2)}K`;
    if (amount < 1000000000) return `$${(amount / 1000000).toFixed(2)}M`;
    return `$${(amount / 1000000000).toFixed(2)}B`;
  }

  async function updateLiquidityInfo() {
    if (!provider) return;

    try {
      $('tokenASymbol').textContent = selectedFrom.symbol;
      $('tokenASymbol2').textContent = selectedFrom.symbol;
      $('tokenASymbol3').textContent = selectedFrom.symbol;
      $('tokenBSymbol').textContent = selectedTo.symbol;
      $('tokenBSymbol2').textContent = selectedTo.symbol;
      $('tokenBSymbol3').textContent = selectedTo.symbol;

      await updateUSDValues();

      const tokenA = selectedFrom.address === 'SIDRA_NATIVE' ? WSIDRA : selectedFrom.address;
      const tokenB = selectedTo.address === 'SIDRA_NATIVE' ? WSIDRA : selectedTo.address;

      currentPair = await factory.getPair(tokenA, tokenB);

      if (currentPair && currentPair !== '0x0000000000000000000000000000000000000000') {
        const pairContract = new ethers.Contract(currentPair, PAIR_ABI, provider);
        const [reserve0, reserve1] = await pairContract.getReserves();
        const token0 = await pairContract.token0();
        const totalSupply = await pairContract.totalSupply();

        let token0Decimals, token1Decimals;

        if (token0.toLowerCase() === tokenA.toLowerCase()) {
          token0Decimals = selectedFrom.decimals;
          token1Decimals = selectedTo.decimals;
        } else {
          token0Decimals = selectedTo.decimals;
          token1Decimals = selectedFrom.decimals;
        }

        const reserve0Formatted = parseFloat(ethers.utils.formatUnits(reserve0, token0Decimals));
        const reserve1Formatted = parseFloat(ethers.utils.formatUnits(reserve1, token1Decimals));

        let reserveA, reserveB;
        if (token0.toLowerCase() === tokenA.toLowerCase()) {
          reserveA = reserve0Formatted;
          reserveB = reserve1Formatted;
        } else {
          reserveA = reserve1Formatted;
          reserveB = reserve0Formatted;
        }

        $('pooledTokenA').textContent = reserveA.toFixed(4);
        $('pooledTokenB').textContent = reserveB.toFixed(4);

        const priceAB = reserveB / reserveA;
        const priceBA = reserveA / reserveB;

        $('priceA').textContent = formatPrice(priceAB);
        $('priceB').textContent = formatPrice(priceBA);

        const [priceTokenA, priceTokenB] = await Promise.all([
          getRealTokenPrice(selectedFrom.symbol),
          getRealTokenPrice(selectedTo.symbol)
        ]);

        const totalLiquidityUSD = (reserveA * priceTokenA) + (reserveB * priceTokenB);

        $('totalLiquidity').textContent = formatUSD(totalLiquidityUSD);

        const dailyVolumeUSD = totalLiquidityUSD * 0.1;
        $('dailyVolume').textContent = formatUSD(dailyVolumeUSD);

        if (account) {
          const userBalance = await pairContract.balanceOf(account);
          const userShare = (parseFloat(ethers.utils.formatEther(userBalance)) / parseFloat(ethers.utils.formatEther(totalSupply))) * 100;
          $('poolSharePercent').textContent = userShare.toFixed(6) + '%';
          $('poolShareValue').textContent = userShare.toFixed(6) + '%';
          $('poolTokens').textContent = parseFloat(ethers.utils.formatEther(userBalance)).toFixed(6);
        } else {
          $('poolSharePercent').textContent = '0%';
          $('poolShareValue').textContent = '0%';
          $('poolTokens').textContent = '0';
        }

        $('liquidityDescription').textContent = `By adding liquidity, you'll earn 0.25% fees on all trades for this token pair. Fees are added to the pool and can be claimed when you remove your liquidity.`;

      } else {
        $('pooledTokenA').textContent = '0';
        $('pooledTokenB').textContent = '0';
        $('priceA').textContent = '0';
        $('priceB').textContent = '0';
        $('poolSharePercent').textContent = '0%';
        $('poolShareValue').textContent = '0%';
        $('poolTokens').textContent = '0';
        $('totalLiquidity').textContent = '$0';
        $('dailyVolume').textContent = '$0';

        $('liquidityDescription').textContent = `You are the first liquidity provider for this pair. The ratio of tokens you add will set the price of this pool.`;
      }
    } catch (error) {
      console.error('Error updating liquidity info:', error);
      $('pooledTokenA').textContent = '0';
      $('pooledTokenB').textContent = '0';
      $('priceA').textContent = '0';
      $('priceB').textContent = '0';
      $('poolSharePercent').textContent = '0%';
      $('poolShareValue').textContent = '0%';
      $('poolTokens').textContent = '0';
      $('totalLiquidity').textContent = '$0';
      $('dailyVolume').textContent = '$0';
    }
  }

  // =============================================
  // TVL STATS
  // =============================================

  async function updateTVLStats() {
    if (!provider) return;

    try {
      let totalTVL = 0;
      const totalPairs = await factory.allPairsLength();

      const majorPairs = [
        { tokenA: 'SIDRA', tokenB: 'USDT' },
        { tokenA: 'SIDRA', tokenB: 'ZICA' },
        { tokenA: 'WSIDRA', tokenB: 'USDT' },
        { tokenA: 'USDT', tokenB: 'ZICA' },
        { tokenA: 'SIDURU', tokenB: 'USDT' }
      ];

      for (const pair of majorPairs) {
        try {
          const tokenA = tokens.find(t => t.symbol === pair.tokenA);
          const tokenB = tokens.find(t => t.symbol === pair.tokenB);

          if (!tokenA || !tokenB) continue;

          const tokenAAddr = tokenA.address === 'SIDRA_NATIVE' ? WSIDRA : tokenA.address;
          const tokenBAddr = tokenB.address === 'SIDRA_NATIVE' ? WSIDRA : tokenB.address;

          const pairAddress = await factory.getPair(tokenAAddr, tokenBAddr);
          if (!pairAddress || pairAddress === '0x0000000000000000000000000000000000000000') continue;

          const pairContract = new ethers.Contract(pairAddress, PAIR_ABI, provider);
          const [reserve0, reserve1] = await pairContract.getReserves();
          const token0 = await pairContract.token0();

          let reserveA, reserveB;
          if (token0.toLowerCase() === tokenAAddr.toLowerCase()) {
            reserveA = reserve0;
            reserveB = reserve1;
          } else {
            reserveA = reserve1;
            reserveB = reserve0;
          }

          const [priceA, priceB] = await Promise.all([
            getRealTokenPrice(tokenA.symbol),
            getRealTokenPrice(tokenB.symbol)
          ]);

          const reserveAValue = parseFloat(ethers.utils.formatUnits(reserveA, tokenA.decimals)) * priceA;
          const reserveBValue = parseFloat(ethers.utils.formatUnits(reserveB, tokenB.decimals)) * priceB;

          totalTVL += reserveAValue + reserveBValue;

        } catch (error) {
          console.error(`Error calculating TVL for ${pair.tokenA}-${pair.tokenB}:`, error);
        }
      }

      $('totalTVL').textContent = formatUSD(totalTVL);
      $('totalPairs').textContent = totalPairs.toString();

    } catch (error) {
      console.error('Error updating TVL stats:', error);
      $('totalTVL').textContent = '$---';
    }
  }

  // =============================================
  // USER POOLS
  // =============================================

  async function loadUserPools() {
    if (!account || !provider) {
      $('noPoolsMessage').style.display = 'block';
      $('poolsList').innerHTML = '';
      return;
    }

    try {
      setStatus('Loading your pools...');
      userPools = [];

      const totalPairs = await factory.allPairsLength();
      $('totalPairs').textContent = totalPairs.toString();

      for (let i = 0; i < Math.min(totalPairs, 100); i++) {
        try {
          const pairAddress = await factory.allPairs(i);
          const pairContract = new ethers.Contract(pairAddress, PAIR_ABI, provider);

          const userBalance = await pairContract.balanceOf(account);

          if (userBalance.gt(0)) {
            const totalSupply = await pairContract.totalSupply();
            const [reserve0, reserve1] = await pairContract.getReserves();
            const token0 = await pairContract.token0();
            const token1 = await pairContract.token1();

            const token0Contract = new ethers.Contract(token0, ERC20_ABI, provider);
            const token1Contract = new ethers.Contract(token1, ERC20_ABI, provider);

            const [symbol0, symbol1, decimals0, decimals1] = await Promise.all([
              token0Contract.symbol(),
              token1Contract.symbol(),
              token0Contract.decimals(),
              token1Contract.decimals()
            ]);

            const reserve0Formatted = parseFloat(ethers.utils.formatUnits(reserve0, decimals0));
            const reserve1Formatted = parseFloat(ethers.utils.formatUnits(reserve1, decimals1));

            const [price0, price1] = await Promise.all([
              getRealTokenPrice(symbol0),
              getRealTokenPrice(symbol1)
            ]);

            const reserve0Value = reserve0Formatted * price0;
            const reserve1Value = reserve1Formatted * price1;
            const totalPoolValue = reserve0Value + reserve1Value;

            const userShare = (parseFloat(ethers.utils.formatEther(userBalance)) / parseFloat(ethers.utils.formatEther(totalSupply))) * 100;
            const userValue = totalPoolValue * (userShare / 100);

            userPools.push({
              address: pairAddress,
              tokenA: symbol0,
              tokenB: symbol1,
              tokenAAddress: token0,
              tokenBAddress: token1,
              balance: parseFloat(ethers.utils.formatEther(userBalance)).toFixed(6),
              share: userShare,
              value: userValue,
              reserves: [reserve0, reserve1],
              token0: token0,
              decimals0: decimals0,
              decimals1: decimals1
            });
          }
        } catch (error) {
          console.error('Error checking pair:', error);
          continue;
        }
      }

      renderUserPools();
      setStatus('Ready');

    } catch (error) {
      console.error('Error loading user pools:', error);
      setStatus('Error loading pools');
      $('noPoolsMessage').style.display = 'block';
    }
  }

  function renderUserPools() {
    const poolsList = $('poolsList');

    if (userPools.length === 0) {
      $('noPoolsMessage').style.display = 'block';
      poolsList.innerHTML = '';
      return;
    }

    $('noPoolsMessage').style.display = 'none';
    poolsList.innerHTML = '';

    userPools.forEach(pool => {
      const poolCard = document.createElement('div');
      poolCard.className = 'pool-card';

      poolCard.innerHTML = `
        <div class="pool-header">
          <div class="pool-tokens">
            <div class="pool-token">
              <img src="https://zicaswap.xyz/assets/${pool.tokenA.toLowerCase()}.png" alt="${pool.tokenA}" onerror="this.src='https://zicaswap.xyz/assets/unknown.png'">
              <span>${pool.tokenA}</span>
            </div>
            <span>+</span>
            <div class="pool-token">
              <img src="https://zicaswap.xyz/assets/${pool.tokenB.toLowerCase()}.png" alt="${pool.tokenB}" onerror="this.src='https://zicaswap.xyz/assets/unknown.png'">
              <span>${pool.tokenB}</span>
            </div>
          </div>
          <div style="color:var(--accent);font-weight:700">$${pool.value.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
        </div>
        <div class="pool-metrics">
          <div class="metric">
            <div class="metric-value">${pool.balance}</div>
            <div class="metric-label">Pool Tokens</div>
          </div>
          <div class="metric">
            <div class="metric-value">${pool.share.toFixed(2)}%</div>
            <div class="metric-label">Share</div>
          </div>
        </div>
        <div class="pool-actions">
          <div class="pool-action pool-add" onclick="addMoreLiquidity('${pool.tokenA}', '${pool.tokenB}')">Add</div>
          <div class="pool-action pool-remove" onclick="showRemoveModal('${pool.address}')">Remove</div>
        </div>
      `;

      poolsList.appendChild(poolCard);
    });
  }

  // =============================================
  // ADD LIQUIDITY
  // =============================================

  async function addLiquidity() {
    if (!account || !signer) {
      await connectWallet();
      if (!account || !signer) return;
    }

    const fromAmt = $('fromAmount').value;
    const toAmt = $('toAmount').value;

    if (!fromAmt || parseFloat(fromAmt) <= 0 || !toAmt || parseFloat(toAmt) <= 0) {
      showToast('Please enter amounts for both tokens');
      return;
    }

    const btn = $('actionBtn');
    try {
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>Processing...';
      setStatus('Preparing add liquidity...');

      if (typeof selectedFrom.decimals === 'undefined' || typeof selectedTo.decimals === 'undefined') {
        showToast('Token decimals belum terdeteksi, coba refresh atau pilih token lain');
        return;
      }

      const amountADesired = ethers.utils.parseUnits(fromAmt, selectedFrom.decimals);
      const amountBDesired = ethers.utils.parseUnits(toAmt, selectedTo.decimals);

      const addressA = (selectedFrom.address === 'SIDRA_NATIVE') ? WSIDRA : selectedFrom.address;
      const addressB = (selectedTo.address === 'SIDRA_NATIVE') ? WSIDRA : selectedTo.address;

      const routerWithSigner = new ethers.Contract(ROUTER, ROUTER_ABI, signer);
      const factoryWithSigner = new ethers.Contract(FACTORY, FACTORY_ABI, signer);

      const pairAddr = await factoryWithSigner.getPair(addressA, addressB);
      if (pairAddr && pairAddr !== ethers.constants.AddressZero && pairAddr !== '0x0000000000000000000000000000000000000000') {
        try {
          const pairContract = new ethers.Contract(pairAddr, PAIR_ABI, provider);
          const [reserve0, reserve1] = await pairContract.getReserves();
          const token0 = await pairContract.token0();

          let reserveA, reserveB;
          if (token0.toLowerCase() === addressA.toLowerCase()) {
            reserveA = reserve0;
            reserveB = reserve1;
          } else {
            reserveA = reserve1;
            reserveB = reserve0;
          }

          const expectedAmountB = amountADesired.mul(reserveB).div(reserveA);
          const ratioDifference = amountBDesired.mul(10000).div(expectedAmountB);

          if (ratioDifference.lt(9500) || ratioDifference.gt(10500)) {
            const confirmRemove = confirm('Warning: Amount ratio differs significantly from pool ratio (>5%). This may result in impermanent loss. Continue anyway?');
            if (!confirmRemove) {
              btn.disabled = false;
              btn.textContent = 'Add Liquidity';
              return;
            }
          }
        } catch (error) {
          console.error('Error validating ratio:', error);
        }
      }

      let finalPairAddr = pairAddr;
      if (!finalPairAddr || finalPairAddr === ethers.constants.AddressZero || finalPairAddr === '0x0000000000000000000000000000000000000000') {
        showToast('Creating new pool...');
        setStatus('Creating new pool...');
        try {
          const txCreate = await factoryWithSigner.createPair(addressA, addressB);
          $('txLink').innerHTML = `<a href="${EXPLORER}/tx/${txCreate.hash}" target="_blank" style="color:var(--accent)">Creating Pair...</a>`;
          await txCreate.wait();
          showToast('Pool created successfully!');
          setStatus('Pool created successfully!');
          finalPairAddr = await factoryWithSigner.getPair(addressA, addressB);
        } catch(e) {
          console.error('Failed to create pair', e);
          showToast('Failed to create pool: ' + (e.message || e));
          setStatus('Create pool failed');
          return;
        }
      }

      const amountAMin = amountADesired.mul(99).div(100);
      const amountBMin = amountBDesired.mul(99).div(100);
      const deadline = Math.floor(Date.now() / 1000) + 60 * 20;

      if (selectedFrom.address === 'SIDRA_NATIVE' && selectedTo.address !== 'SIDRA_NATIVE') {
        await ensureApproved(selectedTo.address, amountBDesired);
        setStatus('Sending addLiquidityETH (native -> token)...');
        const tx = await routerWithSigner.addLiquidityETH(
          selectedTo.address,
          amountBDesired,
          amountBMin,
          amountAMin,
          account,
          deadline,
          { value: amountADesired, gasLimit: 3000000 }
        );
        $('txLink').innerHTML = `<a href="${EXPLORER}/tx/${tx.hash}" target="_blank" style="color:var(--accent)">View on Explorer</a>`;
        await tx.wait();

      } else if (selectedTo.address === 'SIDRA_NATIVE' && selectedFrom.address !== 'SIDRA_NATIVE') {
        await ensureApproved(selectedFrom.address, amountADesired);
        setStatus('Sending addLiquidityETH (token -> native)...');
        const tx = await routerWithSigner.addLiquidityETH(
          selectedFrom.address,
          amountADesired,
          amountAMin,
          amountBMin,
          account,
          deadline,
          { value: amountBDesired, gasLimit: 3000000 }
        );
        $('txLink').innerHTML = `<a href="${EXPLORER}/tx/${tx.hash}" target="_blank" style="color:var(--accent)">View on Explorer</a>`;
        await tx.wait();

      } else {
        await ensureApproved(selectedFrom.address, amountADesired);
        await ensureApproved(selectedTo.address, amountBDesired);
        setStatus('Sending addLiquidity (ERC20 <-> ERC20)...');
        const tx = await routerWithSigner.addLiquidity(
          selectedFrom.address,
          selectedTo.address,
          amountADesired,
          amountBDesired,
          amountAMin,
          amountBMin,
          account,
          deadline,
          { gasLimit: 3000000 }
        );
        $('txLink').innerHTML = `<a href="${EXPLORER}/tx/${tx.hash}" target="_blank" style="color:var(--accent)">View on Explorer</a>`;
        await tx.wait();
      }

      showToast('Liquidity added successfully');
      setStatus('Liquidity added successfully!');

      await updateBalances();
      await updateDropdownBalances();
      await updateLiquidityInfo();
      await loadUserPools();

      $('fromAmount').value = '';
      $('toAmount').value = '';

    } catch (err) {
      console.error('addLiquidity error:', err);
      showToast('Add liquidity failed: ' + (err && err.message ? err.message : err));
      setStatus('Add liquidity failed');
    } finally {
      btn.disabled = false;
      btn.textContent = 'Add Liquidity';
      setStatus('Ready');
    }
  }

  function addMoreLiquidity(tokenA, tokenB) {
    const tokenAObj = tokens.find(t => t.symbol === tokenA);
    const tokenBObj = tokens.find(t => t.symbol === tokenB);

    if (tokenAObj && tokenBObj) {
      selectedFrom = tokenAObj;
      selectedTo = tokenBObj;

      $('fromLogo').src = selectedFrom.logo;
      $('fromSymbol').textContent = selectedFrom.symbol;
      $('toLogo').src = selectedTo.logo;
      $('toSymbol').textContent = selectedTo.symbol;

      switchToAddView();
      updateLiquidityInfo();
      showToast(`Ready to add more ${tokenA}-${tokenB} liquidity`);
    }
  }

  function quickAddLiquidity(tokenASymbol, tokenBSymbol) {
    const tokenA = tokens.find(t => t.symbol === tokenASymbol);
    const tokenB = tokens.find(t => t.symbol === tokenBSymbol);

    if (tokenA && tokenB) {
      selectedFrom = tokenA;
      selectedTo = tokenB;

      $('fromLogo').src = selectedFrom.logo;
      $('fromSymbol').textContent = selectedFrom.symbol;
      $('toLogo').src = selectedTo.logo;
      $('toSymbol').textContent = selectedTo.symbol;

      switchToAddView();
      updateLiquidityInfo();
      showToast(`Ready to add ${tokenASymbol}-${tokenBSymbol} liquidity`);
    }
  }

  function updateActionBtn() {
    const btn = $('actionBtn');
    if (!account) {
      btn.textContent = 'Connect Wallet';
      btn.disabled = false;
      return;
    }

    const fromAmt = parseFloat($('fromAmount').value);
    const toAmt = parseFloat($('toAmount').value);

    if (!fromAmt || fromAmt <= 0 || !toAmt || toAmt <= 0) {
      btn.textContent = 'Enter Amounts';
      btn.disabled = true;
      return;
    }

    btn.textContent = 'Add Liquidity';
    btn.disabled = false;
  }

  // =============================================
  // REMOVE LIQUIDITY
  // =============================================

  async function checkLPAllowance(pairAddress) {
    if (!account || !signer) return false;

    try {
      const pairContract = new ethers.Contract(pairAddress, PAIR_ABI, signer);
      const userBalance = await pairContract.balanceOf(account);
      const allowance = await pairContract.allowance(account, ROUTER);

      return allowance.gte(userBalance);
    } catch (error) {
      console.error('Error checking LP allowance:', error);
      return false;
    }
  }

  async function approveLPTokens(pairAddress) {
    if (!account || !signer) return false;

    try {
      const pairContract = new ethers.Contract(pairAddress, PAIR_ABI, signer);
      const txApprove = await pairContract.approve(ROUTER, ethers.constants.MaxUint256);
      await txApprove.wait();
      return true;
    } catch (error) {
      console.error('Error approving LP tokens:', error);
      return false;
    }
  }

  async function showRemoveModal(poolAddress) {
    currentRemovePool = poolAddress;
    currentRemovePercentage = 0;

    try {
      const pairContract = new ethers.Contract(poolAddress, PAIR_ABI, provider);
      const [reserve0, reserve1] = await pairContract.getReserves();
      const token0 = await pairContract.token0();
      const token1 = await pairContract.token1();
      const userBalance = await pairContract.balanceOf(account);
      const totalSupply = await pairContract.totalSupply();

      const token0Contract = new ethers.Contract(token0, ERC20_ABI, provider);
      const token1Contract = new ethers.Contract(token1, ERC20_ABI, provider);

      const [symbol0, symbol1, decimals0, decimals1] = await Promise.all([
        token0Contract.symbol(),
        token1Contract.symbol(),
        token0Contract.decimals(),
        token1Contract.decimals()
      ]);

      const hasAllowance = await checkLPAllowance(poolAddress);

      $('removePoolInfo').innerHTML = `
        <div style="text-align:center;margin-bottom:16px">
          <div style="display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:8px">
            <img src="https://zicaswap.xyz/assets/${symbol0.toLowerCase()}.png" alt="${symbol0}" style="width:24px;height:24px;border-radius:6px" onerror="this.src='https://zicaswap.xyz/assets/unknown.png'">
            <span style="font-weight:600">${symbol0}</span>
            <span>+</span>
            <img src="https://zicaswap.xyz/assets/${symbol1.toLowerCase()}.png" alt="${symbol1}" style="width:24px;height:24px;border-radius:6px" onerror="this.src='https://zicaswap.xyz/assets/unknown.png'">
            <span style="font-weight:600">${symbol1}</span>
          </div>
          <div style="color:var(--muted);font-size:13px">Your LP Tokens: ${parseFloat(ethers.utils.formatEther(userBalance)).toFixed(6)}</div>
          ${!hasAllowance ? '<div style="color:var(--warning);font-size:12px;margin-top:8px">‚ö†Ô∏è Approval required</div>' : ''}
        </div>
      `;

      $('removeTokenASymbol').textContent = symbol0;
      $('removeTokenBSymbol').textContent = symbol1;

      currentRemovePool = {
        address: poolAddress,
        token0: token0,
        token1: token1,
        symbol0: symbol0,
        symbol1: symbol1,
        decimals0: decimals0,
        decimals1: decimals1,
        userBalance: userBalance,
        totalSupply: totalSupply,
        reserves: [reserve0, reserve1],
        hasAllowance: hasAllowance
      };

      document.querySelectorAll('.percentage-btn').forEach(btn => {
        btn.classList.remove('active');
      });

      $('removeTokenAAmount').textContent = '0';
      $('removeTokenBAmount').textContent = '0';

      $('removeLiquidityModal').style.display = 'flex';

    } catch (error) {
      console.error('Error loading remove modal:', error);
      showToast('Failed to load pool information');
    }
  }

  function setRemovePercentage(percent) {
    currentRemovePercentage = percent;

    document.querySelectorAll('.percentage-btn').forEach(btn => {
      if (parseInt(btn.getAttribute('data-percent')) === percent) {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
    });

    if (currentRemovePool) {
      const liquidityAmount = currentRemovePool.userBalance.mul(percent).div(100);

      const amount0 = currentRemovePool.reserves[0].mul(liquidityAmount).div(currentRemovePool.totalSupply);
      const amount1 = currentRemovePool.reserves[1].mul(liquidityAmount).div(currentRemovePool.totalSupply);

      $('removeTokenAAmount').textContent = parseFloat(ethers.utils.formatUnits(amount0, currentRemovePool.decimals0)).toFixed(6);
      $('removeTokenBAmount').textContent = parseFloat(ethers.utils.formatUnits(amount1, currentRemovePool.decimals1)).toFixed(6);
    }
  }

  function closeRemoveModal() {
    $('removeLiquidityModal').style.display = 'none';
    currentRemovePool = null;
    currentRemovePercentage = 0;
  }

  async function confirmRemoveLiquidity() {
    if (!currentRemovePool || currentRemovePercentage === 0) {
      showToast('Please select a percentage to remove');
      return;
    }

    try {
      setStatus('Removing liquidity...');
      const btn = $('confirmRemoveBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>Removing...';

      const liquidityAmount = currentRemovePool.userBalance.mul(currentRemovePercentage).div(100);

      if (!currentRemovePool.hasAllowance) {
        setStatus('Approving LP tokens...');
        btn.innerHTML = '<span class="spinner"></span>Approving...';

        const approved = await approveLPTokens(currentRemovePool.address);
        if (!approved) {
          throw new Error('Failed to approve LP tokens');
        }

        currentRemovePool.hasAllowance = true;
        setStatus('Approval successful, removing liquidity...');
        btn.innerHTML = '<span class="spinner"></span>Removing...';
      }

      const amount0Min = currentRemovePool.reserves[0].mul(liquidityAmount).div(currentRemovePool.totalSupply).mul(95).div(100);
      const amount1Min = currentRemovePool.reserves[1].mul(liquidityAmount).div(currentRemovePool.totalSupply).mul(95).div(100);

      const deadline = Math.floor(Date.now() / 1000) + 60 * 20;

      setStatus('Removing liquidity...');

      const token0IsNative = currentRemovePool.token0 === WSIDRA;
      const token1IsNative = currentRemovePool.token1 === WSIDRA;

      let tx;

      if (token0IsNative || token1IsNative) {
        const token = token0IsNative ? currentRemovePool.token1 : currentRemovePool.token0;
        const amountTokenMin = token0IsNative ? amount1Min : amount0Min;
        const amountETHMin = token0IsNative ? amount0Min : amount1Min;

        tx = await router.removeLiquidityETH(
          token,
          liquidityAmount,
          amountTokenMin,
          amountETHMin,
          account,
          deadline,
          { gasLimit: 3000000 }
        );
      } else {
        tx = await router.removeLiquidity(
          currentRemovePool.token0,
          currentRemovePool.token1,
          liquidityAmount,
          amount0Min,
          amount1Min,
          account,
          deadline,
          { gasLimit: 3000000 }
        );
      }

      $('txLink').innerHTML = `<a href="${EXPLORER}/tx/${tx.hash}" target="_blank" style="color:var(--accent)">View on Explorer</a>`;
      setStatus('Submitted ‚Äî waiting confirmation...');

      const receipt = await tx.wait();

      showToast('Liquidity removed successfully!');
      setStatus('Liquidity removed');

      closeRemoveModal();
      await updateBalances();
      await updateDropdownBalances();
      loadUserPools();
      updateTVLStats();

    } catch (error) {
      console.error('Error removing liquidity:', error);

      if (error.message && error.message.includes('INSUFFICIENT_A_AMOUNT')) {
        showToast('Failed: Insufficient amount. Try with higher slippage tolerance.');
        setStatus('Failed: Increase slippage tolerance');
      } else if (error.message && error.message.includes('INSUFFICIENT_B_AMOUNT')) {
        showToast('Failed: Insufficient amount. Try with higher slippage tolerance.');
        setStatus('Failed: Increase slippage tolerance');
      } else if (error.message && error.message.includes('user rejected')) {
        showToast('Transaction rejected by user');
        setStatus('Transaction rejected');
      } else {
        showToast('Failed to remove liquidity: ' + (error.message || error));
        setStatus('Remove liquidity failed');
      }
    } finally {
      btn.disabled = false;
      btn.textContent = 'Remove Liquidity';
      setStatus('Ready');
    }
  }

  // =============================================
  // IMPORT POOL
  // =============================================

  async function importPool() {
    const tokenAInput = $('tokenAInput').value.trim();
    const tokenBInput = $('tokenBInput').value.trim();

    if (!tokenAInput || !tokenBInput) {
      showToast('Please enter both token addresses');
      return;
    }

    try {
      setStatus('Importing pool...');

      if (!/^0x[a-fA-F0-9]{40}$/.test(tokenAInput) || !/^0x[a-fA-F0-9]{40}$/.test(tokenBInput)) {
        showToast('Invalid token address format');
        return;
      }

      const pairAddress = await factory.getPair(tokenAInput, tokenBInput);
      if (!pairAddress || pairAddress === '0x0000000000000000000000000000000000000000') {
        showToast('Pool does not exist for these tokens');
        return;
      }

      const tokenAContract = new ethers.Contract(tokenAInput, ERC20_ABI, provider);
      const tokenBContract = new ethers.Contract(tokenBInput, ERC20_ABI, provider);

      const [symbolA, symbolB, decimalsA, decimalsB] = await Promise.all([
        tokenAContract.symbol(),
        tokenBContract.symbol(),
        tokenAContract.decimals(),
        tokenBContract.decimals()
      ]);

      const tokenAObj = {
        symbol: symbolA,
        address: tokenAInput,
        decimals: decimalsA,
        logo: `https://zicaswap.xyz/assets/${symbolA.toLowerCase()}.png`,
        custom: true,
        verified: false
      };

      const tokenBObj = {
        symbol: symbolB,
        address: tokenBInput,
        decimals: decimalsB,
        logo: `https://zicaswap.xyz/assets/${symbolB.toLowerCase()}.png`,
        custom: true,
        verified: false
      };

      if (!tokens.some(t => t.address.toLowerCase() === tokenAInput.toLowerCase())) {
        tokens.push(tokenAObj);
      }

      if (!tokens.some(t => t.address.toLowerCase() === tokenBInput.toLowerCase())) {
        tokens.push(tokenBObj);
      }

      saveCustomTokens();

      selectedFrom = tokenAObj;
      selectedTo = tokenBObj;

      $('fromLogo').src = selectedFrom.logo;
      $('fromSymbol').textContent = selectedFrom.symbol;
      $('toLogo').src = selectedTo.logo;
      $('toSymbol').textContent = selectedTo.symbol;

      switchToAddView();
      updateLiquidityInfo();

      showToast(`Pool ${symbolA}-${symbolB} imported successfully!`);
      setStatus('Pool imported');

    } catch (error) {
      console.error('Error importing pool:', error);
      showToast('Failed to import pool: ' + (error.message || error));
      setStatus('Import failed');
    }
  }

  // =============================================
  // HELPER FUNCTIONS
  // =============================================

  async function ensureApproved(tokenAddress, neededAmount) {
    if (!tokenAddress || tokenAddress === 'SIDRA_NATIVE') return;

    try {
      const tokenContract = new ethers.Contract(tokenAddress, ERC20_ABI, signer);
      const allowance = await tokenContract.allowance(account, ROUTER);
      if (ethers.BigNumber.from(allowance).lt(neededAmount)) {
        setStatus('Approving token ' + (tokenAddress) + ' ...');
        const tx = await tokenContract.approve(ROUTER, ethers.constants.MaxUint256);
        await tx.wait();
      }
    } catch (err) {
      console.error('ensureApproved error for', tokenAddress, err);
      throw err;
    }
  }

  // =============================================
  // EVENT LISTENERS
  // =============================================

  $('actionBtn').addEventListener('click', addLiquidity);

  $('fromAmount').addEventListener('input', function() {
    updateUSDValues();
    updateActionBtn();

    if (!isCalculatingA) {
      calculateOptimalAmountB();
    }
  });

  $('toAmount').addEventListener('input', function() {
    updateUSDValues();
    updateActionBtn();

    if (!isCalculatingB) {
      calculateOptimalAmountA();
    }
  });

  window.addEventListener('click', (e) => {
    if (e.target === $('removeLiquidityModal')) {
      closeRemoveModal();
    }
  });

  // =============================================
  // INITIALIZATION
  // =============================================

  document.addEventListener('DOMContentLoaded', async () => {
    loadCustomTokens();

    try {
      provider = new ethers.providers.JsonRpcProvider(RPC);
      factory = new ethers.Contract(FACTORY, FACTORY_ABI, provider);

      updateTVLStats();

      if (window.ethereum && window.ethereum.selectedAddress) {
        account = window.ethereum.selectedAddress;
        connectBtn.textContent = account.substring(0,6) + '...' + account.substring(38);
        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        router = new ethers.Contract(ROUTER, ROUTER_ABI, signer);
        await updateBalances();
        await updateDropdownBalances();
        updateActionBtn();
        updateLiquidityInfo();
        loadUserPools();
      }
    } catch (error) {
      console.error('Initialization error:', error);
    }

    switchToMyPoolsView();

    setInterval(async () => {
      if (provider) {
        await updateTVLStats();
        await updateUSDValues();
        if (account) {
          await loadUserPools();
        }
      }
    }, 30000);
  });

  // Export functions to global scope
  window.switchToMyPoolsView = switchToMyPoolsView;
  window.switchToAddView = switchToAddView;
  window.switchToImportView = switchToImportView;
  window.quickAddLiquidity = quickAddLiquidity;
  window.addMoreLiquidity = addMoreLiquidity;
  window.showRemoveModal = showRemoveModal;
  window.setRemovePercentage = setRemovePercentage;
  window.closeRemoveModal = closeRemoveModal;
  window.confirmRemoveLiquidity = confirmRemoveLiquidity;
  window.importPool = importPool;
  window.filterTokens = filterTokens;
  window.addLiquidity = addLiquidity;
  window.setMax = setMax;
</script>
</body>
</html>